name: Healthcare Compliance Monitoring

on:
  schedule:
    - cron: '0 6 * * *' # Daily at 6 AM UTC
  push:
    paths:
      - 'packages/compliance/**'
      - 'apps/*/app/**'
      - 'packages/security/**'
  workflow_dispatch:
    inputs:
      compliance_scope:
        description: 'Compliance scope to check'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - hipaa
        - lgpd
        - anvisa
        - cfm

concurrency:
  group: healthcare-compliance-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'

jobs:
  hipaa-compliance-check:
    name: HIPAA Compliance Validation
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event.inputs.compliance_scope == 'all' || github.event.inputs.compliance_scope == 'hipaa' || github.event.inputs.compliance_scope == null

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js & pnpm
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: HIPAA Security Safeguards Check
        run: |
          echo "üîí Validating HIPAA Security Safeguards..."
          pnpm run compliance:hipaa:security

      - name: PHI Data Handling Validation
        run: |
          echo "üè• Checking PHI data handling compliance..."
          pnpm run compliance:hipaa:phi-handling

      - name: Encryption Standards Verification
        run: |
          echo "üîê Verifying HIPAA encryption requirements..."
          pnpm run compliance:hipaa:encryption

      - name: Access Control Audit
        run: |
          echo "üë§ Auditing HIPAA access controls..."
          pnpm run compliance:hipaa:access-control

      - name: Audit Trail Validation
        run: |
          echo "üìù Validating HIPAA audit trail requirements..."
          pnpm run compliance:hipaa:audit-trail

      - name: Generate HIPAA Compliance Report
        run: |
          echo "üìä Generating HIPAA compliance report..."
          node scripts/generate-hipaa-report.js

      - name: Upload HIPAA Report
        uses: actions/upload-artifact@v4
        with:
          name: hipaa-compliance-report-${{ github.run_number }}
          path: |
            reports/hipaa-compliance.json
            reports/hipaa-audit.html
            reports/phi-handling-analysis.json
          retention-days: 365 # Keep for audit purposes

  lgpd-compliance-check:
    name: LGPD Compliance Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event.inputs.compliance_scope == 'all' || github.event.inputs.compliance_scope == 'lgpd' || github.event.inputs.compliance_scope == null

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js & pnpm
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: LGPD Consent Management Validation
        run: |
          echo "üìã Validating LGPD consent management..."
          pnpm run compliance:lgpd:consent

      - name: Data Subject Rights Implementation
        run: |
          echo "‚öñÔ∏è Checking data subject rights implementation..."
          pnpm run compliance:lgpd:data-rights

      - name: Data Processing Lawfulness
        run: |
          echo "üìä Verifying data processing lawfulness..."
          pnpm run compliance:lgpd:processing

      - name: Privacy Policy Compliance
        run: |
          echo "üìú Checking privacy policy compliance..."
          pnpm run compliance:lgpd:privacy-policy

      - name: Data Protection Impact Assessment
        run: |
          echo "üõ°Ô∏è Conducting DPIA validation..."
          pnpm run compliance:lgpd:dpia

      - name: Generate LGPD Compliance Report
        run: |
          echo "üìä Generating LGPD compliance report..."
          node scripts/generate-lgpd-report.js

      - name: Upload LGPD Report
        uses: actions/upload-artifact@v4
        with:
          name: lgpd-compliance-report-${{ github.run_number }}
          path: |
            reports/lgpd-compliance.json
            reports/lgpd-audit.html
            reports/data-rights-analysis.json
          retention-days: 365

  anvisa-compliance-check:
    name: ANVISA Medical Device Compliance
    runs-on: ubuntu-latest
    timeout-minutes: 18
    if: github.event.inputs.compliance_scope == 'all' || github.event.inputs.compliance_scope == 'anvisa' || github.event.inputs.compliance_scope == null

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js & pnpm
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Medical Device Registration Validation
        run: |
          echo "üè• Validating ANVISA medical device registration..."
          pnpm run compliance:anvisa:device-registration

      - name: Adverse Event Reporting System
        run: |
          echo "‚ö†Ô∏è Checking adverse event reporting compliance..."
          pnpm run compliance:anvisa:adverse-events

      - name: Product Classification Validation
        run: |
          echo "üìã Validating product classification..."
          pnpm run compliance:anvisa:classification

      - name: Quality Management System
        run: |
          echo "‚úÖ Checking QMS compliance..."
          pnpm run compliance:anvisa:qms

      - name: Clinical Data Requirements
        run: |
          echo "üß™ Validating clinical data requirements..."
          pnpm run compliance:anvisa:clinical-data

      - name: Generate ANVISA Compliance Report
        run: |
          echo "üìä Generating ANVISA compliance report..."
          node scripts/generate-anvisa-report.js

      - name: Upload ANVISA Report
        uses: actions/upload-artifact@v4
        with:
          name: anvisa-compliance-report-${{ github.run_number }}
          path: |
            reports/anvisa-compliance.json
            reports/anvisa-audit.html
            reports/device-registration.json
          retention-days: 365

  cfm-compliance-check:
    name: CFM Professional Standards Compliance
    runs-on: ubuntu-latest
    timeout-minutes: 12
    if: github.event.inputs.compliance_scope == 'all' || github.event.inputs.compliance_scope == 'cfm' || github.event.inputs.compliance_scope == null

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js & pnpm
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Medical Professional Registration
        run: |
          echo "üë©‚Äç‚öïÔ∏è Validating medical professional registration..."
          pnpm run compliance:cfm:professional-registration

      - name: Telemedicine Compliance
        run: |
          echo "üíª Checking telemedicine compliance..."
          pnpm run compliance:cfm:telemedicine

      - name: Medical Ethics Validation
        run: |
          echo "‚öñÔ∏è Validating medical ethics compliance..."
          pnpm run compliance:cfm:ethics

      - name: Continuing Education Requirements
        run: |
          echo "üìö Checking continuing education compliance..."
          pnpm run compliance:cfm:education

      - name: Digital Prescription Compliance
        run: |
          echo "üíä Validating digital prescription compliance..."
          pnpm run compliance:cfm:prescriptions

      - name: Generate CFM Compliance Report
        run: |
          echo "üìä Generating CFM compliance report..."
          node scripts/generate-cfm-report.js

      - name: Upload CFM Report
        uses: actions/upload-artifact@v4
        with:
          name: cfm-compliance-report-${{ github.run_number }}
          path: |
            reports/cfm-compliance.json
            reports/cfm-audit.html
            reports/professional-validation.json
          retention-days: 365

  constitutional-compliance-check:
    name: Constitutional Healthcare Framework Validation
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: [hipaa-compliance-check, lgpd-compliance-check, anvisa-compliance-check, cfm-compliance-check]
    if: always()

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js & pnpm
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Download All Compliance Reports
        uses: actions/download-artifact@v4

      - name: Constitutional Framework Validation
        run: |
          echo "üèõÔ∏è Validating constitutional healthcare framework..."
          pnpm run compliance:constitutional:validate

      - name: Cross-Compliance Integration Check
        run: |
          echo "üîó Checking cross-compliance integration..."
          node scripts/validate-cross-compliance.js

      - name: Healthcare Quality Standards
        run: |
          echo "‚≠ê Validating healthcare quality standards..."
          pnpm run compliance:quality-standards

      - name: Patient Safety Framework
        run: |
          echo "üõ°Ô∏è Checking patient safety framework..."
          pnpm run compliance:patient-safety

      - name: Generate Comprehensive Compliance Report
        run: |
          echo "üìä Generating comprehensive compliance report..."
          node scripts/generate-comprehensive-compliance-report.js
        env:
          REPORT_DATE: ${{ github.run_number }}
          COMPLIANCE_SCOPE: ${{ github.event.inputs.compliance_scope || 'all' }}

      - name: Upload Comprehensive Report
        uses: actions/upload-artifact@v4
        with:
          name: comprehensive-compliance-report-${{ github.run_number }}
          path: |
            reports/comprehensive-compliance.html
            reports/compliance-dashboard.json
            reports/regulatory-status.json
            reports/recommendations.md
          retention-days: 365

      - name: Update Compliance Dashboard
        run: |
          echo "üìà Updating real-time compliance dashboard..."
          curl -X POST "${{ secrets.COMPLIANCE_DASHBOARD_URL }}" \
            -H "Authorization: Bearer ${{ secrets.COMPLIANCE_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d @reports/compliance-dashboard.json

      - name: Compliance Alert on Violations
        if: contains(needs.*.result, 'failure')
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#healthcare-compliance'
          text: |
            üö® CRITICAL: Healthcare Compliance Violations Detected!
            
            Scope: ${{ github.event.inputs.compliance_scope || 'all' }}
            Report ID: ${{ github.run_number }}
            
            üè• Regulatory Compliance Status:
            ‚Ä¢ HIPAA: ${{ needs.hipaa-compliance-check.result }}
            ‚Ä¢ LGPD: ${{ needs.lgpd-compliance-check.result }}
            ‚Ä¢ ANVISA: ${{ needs.anvisa-compliance-check.result }}
            ‚Ä¢ CFM: ${{ needs.cfm-compliance-check.result }}
            
            IMMEDIATE ACTION REQUIRED
            This may impact regulatory standing and patient safety.
            
            View full report: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Compliance Success Notification
        if: needs.hipaa-compliance-check.result == 'success' && needs.lgpd-compliance-check.result == 'success' && needs.anvisa-compliance-check.result == 'success' && needs.cfm-compliance-check.result == 'success'
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#healthcare-compliance'
          text: |
            ‚úÖ Healthcare Compliance Validation Complete
            
            All regulatory frameworks validated successfully:
            
            üè• HIPAA Compliance: ‚úÖ Passed
            ‚öñÔ∏è LGPD Compliance: ‚úÖ Passed
            üè• ANVISA Compliance: ‚úÖ Passed
            üë©‚Äç‚öïÔ∏è CFM Compliance: ‚úÖ Passed
            
            üìä Full compliance report available
            üõ°Ô∏è Patient data protection verified
            ‚≠ê Quality standards maintained
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}