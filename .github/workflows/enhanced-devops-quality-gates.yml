name: ğŸ”° Enhanced DevOps Quality Gates - Healthcare â‰¥9.9/10

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
  schedule:
    # Run comprehensive checks daily at 3 AM UTC
    - cron: '0 3 * * *'

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'
  HEALTHCARE_STANDARD: '9.9'
  CONSTITUTIONAL_AI_MODE: 'true'
  QUALITY_THRESHOLD: '99'

jobs:
  # Phase 1: Pre-flight Quality Assessment
  pre-flight-assessment:
    name: ğŸ” Pre-flight Quality Assessment
    runs-on: ubuntu-latest
    outputs:
      baseline-score: ${{ steps.baseline.outputs.score }}
      risk-level: ${{ steps.risk.outputs.level }}
      ai-governance-status: ${{ steps.ai-governance.outputs.status }}
    
    steps:
      - name: ğŸ“¥ Checkout Healthcare Codebase
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”§ Setup Enhanced Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸš€ Install Dependencies with Cache Optimization
        run: |
          pnpm install --frozen-lockfile
          pnpm store status

      - name: ğŸ¯ Baseline Quality Assessment
        id: baseline
        run: |
          echo "ğŸ” Running baseline quality assessment..."
          SCORE=$(pnpm run quality:assess --json | jq -r '.overallScore')
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Baseline Quality Score: $SCORE/10"

      - name: âš ï¸ Risk Level Assessment
        id: risk
        run: |
          echo "âš ï¸ Assessing healthcare risk level..."
          RISK=$(pnpm run healthcare:risk-assessment --json | jq -r '.riskLevel')
          echo "level=$RISK" >> $GITHUB_OUTPUT
          echo "ğŸš¨ Risk Level: $RISK"

      - name: ğŸ¤– Constitutional AI Governance Check
        id: ai-governance
        run: |
          echo "ğŸ¤– Validating Constitutional AI governance..."
          STATUS=$(pnpm run ai:governance-check --json | jq -r '.status')
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "âœ… AI Governance Status: $STATUS"  # Phase 2: Advanced Security & Compliance Validation
  advanced-security-compliance:
    name: ğŸ›¡ï¸ Advanced Security & Compliance
    runs-on: ubuntu-latest
    needs: pre-flight-assessment
    if: needs.pre-flight-assessment.outputs.risk-level != 'CRITICAL'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Environment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¦ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ”’ Advanced Security Scanning
        run: |
          echo "ğŸ”’ Running advanced security scans..."
          pnpm run security:advanced-scan
          pnpm run security:dependency-check
          pnpm run security:secrets-scan

      - name: ğŸ¥ Healthcare Compliance Validation
        run: |
          echo "ğŸ¥ Validating healthcare compliance..."
          pnpm run compliance:lgpd-validation
          pnpm run compliance:anvisa-check
          pnpm run compliance:cfm-validation
          pnpm run compliance:iso27001-audit

      - name: ğŸ” Encryption & Data Protection Audit
        run: |
          echo "ğŸ” Auditing encryption and data protection..."
          pnpm run security:encryption-audit
          pnpm run security:data-protection-check  # Phase 3: Performance & Load Testing
  performance-validation:
    name: âš¡ Performance & Load Validation
    runs-on: ubuntu-latest
    needs: [pre-flight-assessment, advanced-security-compliance]
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Environment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¦ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ Build Application
        run: pnpm build

      - name: âš¡ Core Web Vitals Testing
        run: |
          echo "âš¡ Testing Core Web Vitals..."
          pnpm run performance:web-vitals
          echo "ğŸ“Š Lighthouse CI Analysis..."
          pnpm exec lighthouse-ci autorun

      - name: ğŸ“ˆ Load Testing
        run: |
          echo "ğŸ“ˆ Running load tests..."
          pnpm run test:load
          pnpm run test:stress
          pnpm run test:spike

      - name: ğŸ¯ API Performance Testing
        run: |
          echo "ğŸ¯ Testing API performance..."
          pnpm run test:api-performance
          pnpm run test:database-performance

      - name: ğŸ“Š Performance Report Generation
        run: |
          echo "ğŸ“Š Generating performance reports..."
          pnpm run performance:report  # Phase 4: Comprehensive Testing & Coverage
  comprehensive-testing:
    name: ğŸ§ª Comprehensive Testing & Coverage
    runs-on: ubuntu-latest
    needs: [performance-validation]
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Environment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¦ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ§ª Unit Testing with Coverage
        run: |
          echo "ğŸ§ª Running unit tests..."
          pnpm run test:unit:coverage
          echo "ğŸ“Š Coverage Threshold: â‰¥95%"

      - name: ğŸ¥ Healthcare-Specific Testing
        run: |
          echo "ğŸ¥ Running healthcare compliance tests..."
          pnpm run test:healthcare
          pnpm run test:lgpd
          pnpm run test:anvisa
          pnpm run test:patient-privacy

      - name: ğŸ­ E2E Testing
        run: |
          echo "ğŸ­ Running E2E tests..."
          pnpm run test:e2e
          pnpm run test:accessibility

      - name: ğŸ”’ Security Testing
        run: |
          echo "ğŸ”’ Running security tests..."
          pnpm run test:security
          pnpm run test:penetration

      - name: ğŸ“Š Generate Coverage Reports
        run: |
          echo "ğŸ“Š Generating coverage reports..."
          pnpm run test:coverage-report  # Phase 5: Final Quality Certification & Healthcare Override
  final-quality-certification:
    name: ğŸ† Final Quality Certification (â‰¥9.9/10)
    runs-on: ubuntu-latest
    needs: [comprehensive-testing]
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Environment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¦ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ¯ Final Quality Assessment
        id: quality-assessment
        run: |
          echo "ğŸ¯ Running final quality assessment..."
          QUALITY_SCORE=$(pnpm run quality:final-assessment --json | jq -r '.score')
          echo "ğŸ“Š Final Quality Score: $QUALITY_SCORE/10"
          echo "quality_score=$QUALITY_SCORE" >> $GITHUB_OUTPUT
          
          if [ $(echo "$QUALITY_SCORE >= 9.9" | bc) -eq 1 ]; then
            echo "âœ… Healthcare Quality Standard Met: $QUALITY_SCORE/10"
            echo "healthcare_standard=PASSED" >> $GITHUB_OUTPUT
          else
            echo "âŒ Healthcare Quality Standard Not Met: $QUALITY_SCORE/10 (Required: â‰¥9.9/10)"
            echo "healthcare_standard=FAILED" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ğŸ¥ Healthcare Compliance Certification
        run: |
          echo "ğŸ¥ Generating healthcare compliance certification..."
          pnpm run compliance:generate-certificate
          echo "ğŸ“‹ LGPD Compliance: $(pnpm run compliance:lgpd-status)"
          echo "ğŸ›ï¸ ANVISA Compliance: $(pnpm run compliance:anvisa-status)"
          echo "ğŸ¤– Constitutional AI: $(pnpm run ai:governance-status)"

      - name: ğŸš€ Production Readiness Validation
        run: |
          echo "ğŸš€ Validating production readiness..."
          pnpm run deployment:readiness-check
          echo "âœ… All systems ready for deployment"

      - name: ğŸ“Š Generate Quality Report
        run: |
          echo "ğŸ“Š Generating comprehensive quality report..."
          pnpm run quality:generate-report
          echo "ğŸ“‹ Report available in: reports/quality-assessment-$(date +%Y%m%d).html"

      - name: ğŸ† Success Notification
        if: steps.quality-assessment.outputs.healthcare_standard == 'PASSED'
        run: |
          echo "ğŸ† SUCCESS: NEONPRO Healthcare DevOps Quality Gates PASSED"
          echo "âœ… Quality Score: ${{ steps.quality-assessment.outputs.quality_score }}/10"
          echo "âœ… Healthcare Standard: â‰¥9.9/10 ACHIEVED"
          echo "âœ… Production Ready: YES"