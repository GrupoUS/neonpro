name: ðŸ” PR Validation - Code Quality & Fast Testing

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_target:
    branches: [main]
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8.15.0'

# Prevent multiple concurrent runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.number }}
  cancel-in-progress: true

jobs:
  # ==================================================================
  # PR METADATA & SAFETY CHECK
  # ==================================================================
  pr-safety-check:
    name: ðŸ›¡ï¸ PR Safety Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    outputs:
      safe-to-test: ${{ steps.safety.outputs.safe }}
      changed-files: ${{ steps.changes.outputs.files }}
    
    steps:
      - name: ðŸ“¥ Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: ðŸ” Safety Validation
        id: safety
        run: |
          echo "ðŸ›¡ï¸ Validating PR safety..."
          
          # Check for package.json changes that could be malicious
          if git diff --name-only origin/main..HEAD | grep -E "(package\.json|pnpm-lock\.yaml)"; then
            echo "âš ï¸ Package files modified - manual review required"
            echo "ðŸ” Dependency changes detected"
          fi
          
          # Check for workflow changes
          if git diff --name-only origin/main..HEAD | grep -E "\.github/workflows/"; then
            echo "âš ï¸ Workflow files modified - manual review required"
          fi
          
          echo "safe=true" >> $GITHUB_OUTPUT
          echo "âœ… PR safety check passed"

      - name: ðŸ“‹ Detect Changed Files
        id: changes
        run: |
          echo "ðŸ“‹ Detecting changed files..."
          CHANGED_FILES=$(git diff --name-only origin/main..HEAD | tr '\n' ' ')
          echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "Changed files: $CHANGED_FILES"

  # ==================================================================
  # FAST QUALITY VALIDATION
  # ==================================================================
  fast-quality-check:
    name: âš¡ Fast Quality Check
    runs-on: ubuntu-latest
    needs: pr-safety-check
    if: needs.pr-safety-check.outputs.safe-to-test == 'true'
    
    steps:
      - name: ðŸ“¥ Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: âš¡ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸŽ¯ Format Check (Biome + Ultracite)
        run: |
          echo "ðŸŽ¯ Running Format Check with Biome + Ultracite..."
          pnpm exec biome format --check .
          echo "âœ… Format check completed"

      - name: ðŸ” Lint Check (Biome + Ultracite)
        run: |
          echo "ðŸ” Running Lint Check with Biome + Ultracite..."
          pnpm exec biome lint .
          echo "âœ… Lint check completed"

      - name: ðŸ”§ TypeScript Check
        run: |
          echo "ðŸ”§ Running TypeScript validation..."
          pnpm type-check
          echo "âœ… TypeScript check completed"

      - name: ðŸ“Š Quality Summary
        run: |
          echo "## âš¡ Fast Quality Check Results" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Format**: Biome + Ultracite validation passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Lint**: No linting errors found" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **TypeScript**: Type validation successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ¯ **PR ready for further validation!**" >> $GITHUB_STEP_SUMMARY

  # ==================================================================
  # FOCUSED TESTING (Related to Changes)
  # ==================================================================
  focused-testing:
    name: ðŸŽ¯ Focused Testing
    runs-on: ubuntu-latest
    needs: [pr-safety-check, fast-quality-check]
    if: needs.fast-quality-check.result == 'success'
    
    strategy:
      matrix:
        test-suite: [unit-related, build-test]
    
    steps:
      - name: ðŸ“¥ Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: âš¡ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ§ª Related Unit Tests (Vitest)
        if: matrix.test-suite == 'unit-related'
        run: |
          echo "ðŸ§ª Running tests related to PR changes..."
          echo "Changed files: ${{ needs.pr-safety-check.outputs.changed-files }}"
          
          # Run tests with coverage for changed files
          if echo "${{ needs.pr-safety-check.outputs.changed-files }}" | grep -E "\.(ts|tsx|js|jsx)$"; then
            echo "ðŸŽ¯ Running focused unit tests..."
            pnpm test:unit --reporter=verbose
          else
            echo "â„¹ï¸ No test-relevant files changed"
          fi
          echo "âœ… Unit tests completed"

      - name: ðŸ—ï¸ Build Validation
        if: matrix.test-suite == 'build-test'
        run: |
          echo "ðŸ—ï¸ Validating build with PR changes..."
          pnpm build
          echo "âœ… Build validation completed"

      - name: ðŸ“Š Upload Test Results
        if: matrix.test-suite == 'unit-related'
        uses: actions/upload-artifact@v4
        with:
          name: pr-test-results
          path: |
            tools/testing/coverage/
            test-results/
          retention-days: 7

  # ==================================================================
  # PR SIZE & COMPLEXITY ANALYSIS
  # ==================================================================
  pr-analysis:
    name: ðŸ“Š PR Analysis
    runs-on: ubuntu-latest
    needs: pr-safety-check
    
    steps:
      - name: ðŸ“¥ Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: ðŸ“Š PR Size Analysis
        run: |
          echo "ðŸ“Š Analyzing PR size and complexity..."
          
          # Count changed lines
          ADDED_LINES=$(git diff --numstat origin/main..HEAD | awk '{sum += $1} END {print sum}')
          DELETED_LINES=$(git diff --numstat origin/main..HEAD | awk '{sum += $2} END {print sum}')
          CHANGED_FILES=$(git diff --name-only origin/main..HEAD | wc -l)
          
          echo "ðŸ“ˆ Added lines: $ADDED_LINES"
          echo "ðŸ“‰ Deleted lines: $DELETED_LINES"
          echo "ðŸ“ Changed files: $CHANGED_FILES"
          
          # Determine PR size
          TOTAL_CHANGES=$((ADDED_LINES + DELETED_LINES))
          if [ $TOTAL_CHANGES -lt 100 ]; then
            SIZE="ðŸŸ¢ Small"
            COMPLEXITY="Low"
          elif [ $TOTAL_CHANGES -lt 500 ]; then
            SIZE="ðŸŸ¡ Medium"
            COMPLEXITY="Moderate"
          elif [ $TOTAL_CHANGES -lt 1000 ]; then
            SIZE="ðŸŸ  Large"
            COMPLEXITY="High"
          else
            SIZE="ðŸ”´ Extra Large"
            COMPLEXITY="Very High"
          fi
          
          echo "size=$SIZE" >> $GITHUB_ENV
          echo "complexity=$COMPLEXITY" >> $GITHUB_ENV

      - name: ðŸ” Healthcare Compliance Check
        run: |
          echo "ðŸ¥ Checking healthcare compliance for PR changes..."
          
          # Check for potential LGPD/healthcare data handling
          if git diff origin/main..HEAD | grep -i "cpf\|rg\|patient\|medical"; then
            echo "ðŸ¥ Healthcare data handling detected - ensure compliance"
            echo "healthcare_data=true" >> $GITHUB_ENV
          else
            echo "healthcare_data=false" >> $GITHUB_ENV
          fi

      - name: ðŸ“‹ PR Summary Report
        run: |
          echo "# ðŸ“Š PR Analysis Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ PR Size & Complexity" >> $GITHUB_STEP_SUMMARY
          echo "- **Size**: ${{ env.size }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Complexity**: ${{ env.complexity }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Files Changed**: $(git diff --name-only origin/main..HEAD | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ¥ Compliance Status" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.healthcare_data }}" = "true" ]; then
            echo "- âš ï¸ **Healthcare Data**: Changes detected - manual compliance review required" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… **Healthcare Data**: No sensitive data changes detected" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Changed Areas" >> $GITHUB_STEP_SUMMARY
          git diff --name-only origin/main..HEAD | head -10 | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY

  # ==================================================================
  # PR VALIDATION GATE
  # ==================================================================
  pr-validation-gate:
    name: ðŸšª PR Validation Gate
    runs-on: ubuntu-latest
    needs: [pr-safety-check, fast-quality-check, focused-testing, pr-analysis]
    if: always()
    
    steps:
      - name: ðŸ” Evaluate PR Gate
        run: |
          echo "ðŸšª Evaluating PR Validation Gate..."
          
          # Check all required validations
          if [ "${{ needs.pr-safety-check.result }}" = "success" ] && \
             [ "${{ needs.fast-quality-check.result }}" = "success" ] && \
             [ "${{ needs.focused-testing.result }}" = "success" ]; then
            echo "âœ… PR Validation Gate: APPROVED"
            echo "ðŸŽ¯ All quality checks passed"
            echo "ðŸš€ PR ready for review and merge"
          else
            echo "âŒ PR Validation Gate: FAILED"
            echo "Safety Check: ${{ needs.pr-safety-check.result }}"
            echo "Quality Check: ${{ needs.fast-quality-check.result }}"
            echo "Testing: ${{ needs.focused-testing.result }}"
            exit 1
          fi

      - name: ðŸŽ¯ Final PR Status
        run: |
          echo "# ðŸŽ¯ PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ›¡ï¸ **Safety Check**: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "- âš¡ **Quality Check**: âœ… Biome + Ultracite validation successful" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§ª **Testing**: âœ… Focused tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š **Analysis**: âœ… PR analysis completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ **This PR is ready for review!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Validated with NeonPro Healthcare Platform standards_" >> $GITHUB_STEP_SUMMARY

  # ==================================================================
  # AUTO-MERGE FOR DEPENDENCY UPDATES (Optional)
  # ==================================================================
  auto-merge-dependencies:
    name: ðŸ¤– Auto-merge Dependencies
    runs-on: ubuntu-latest
    needs: pr-validation-gate
    if: >
      github.actor == 'dependabot[bot]' &&
      needs.pr-validation-gate.result == 'success' &&
      contains(github.event.pull_request.title, 'chore(deps)')
    
    steps:
      - name: ðŸ¤– Enable auto-merge for Dependabot
        run: |
          echo "ðŸ¤– Auto-merge approved for dependency update"
          echo "âœ… All validations passed"
          echo "ðŸ”’ Safe to auto-merge"
          
          # Note: Actual auto-merge would require additional setup
          # This is just a placeholder for the logic