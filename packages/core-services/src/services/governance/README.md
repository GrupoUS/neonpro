# Governance Services (Phase 1 TDD)

This module provides initial in‑memory implementations for governance-related domain capabilities introduced by the Unified PRD Index initiative.

## Scope (Phase 1)

- KPI Service (register, archive, evaluate, list)
- Policy Service (register, attach, evaluate, listAttachments)
- Escalation Service (trigger, list)
- Prioritization Service (scoreFeature, list)
- Risk Service (register, list)
- Pure helper functions (risk exposure, KPI evaluation, priority scoring, policy aggregation, escalation id, provisional aging)
- Placeholder Zod schemas for future FR-033

All logic is intentionally minimal—focused on passing contract, scenario, unit, and placeholder tests. Persistence, advanced rule engines, temporal logic, and schema validation are deferred to later phases.

## Test Layering

| Layer       | Folder                  | Purpose                                                                                |
| ----------- | ----------------------- | -------------------------------------------------------------------------------------- |
| Contract    | `__tests__/contract`    | Public API expectations & invariants (duplicate rejection, required fields)            |
| Scenario    | `__tests__/scenario`    | Cross-service flows & temporal states (aging, escalation triggers)                     |
| Unit        | `__tests__/unit`        | Pure function & service internal behavior (scoring, aggregation, threshold evaluation) |
| Placeholder | `__tests__/placeholder` | Reserved for future schema & advanced validations                                      |

## Services Overview

### InMemoryKPIService

- Tracks provisional KPIs (status `Provisional`) including `provisionalSince` timestamp.
- `evaluate` updates last value/status/delta based on direction & target.
- Aging detection (>60 days) stubbed for future automatic escalation integration.

### InMemoryPolicyService

- Registers boolean rule policies.
- Idempotent `attach` with threshold resolution.
- Aggregates rule results into `pass | partial | fail`.

### InMemoryEscalationService

- Generates receipts for escalation triggers (deferred path orchestration logic).

### InMemoryPrioritizationService

- Weighted formula: `impact*2 + riskReduction*1.5 + strategicFit*1.2 - effort` → priority tier mapping.

### InMemoryRiskService

- Computes exposure = probability \* impact.

## Helper Functions

| Helper                 | Description                                               |
| ---------------------- | --------------------------------------------------------- |
| `computeRiskExposure`  | exposure = probability \* impact                          |
| `evaluateKPIValue`     | Determines within/breach & delta given direction & target |
| `scorePriority`        | Raw priority weighting before tier mapping                |
| `aggregatePolicyRules` | Boolean rule aggregation into final status                |
| `generateEscalationId` | Timestamp-based id stub                                   |
| `isProvisionalAging`   | Detects >60 day provisional window                        |

## Deferred / Future Work

- Persistence layer & repository abstraction.
- Rule engine with threshold expressions (e.g. `<5%`).
- Automatic escalation triggers (currently manual in tests).
- Zod schemas & input validation (replace placeholder file).
- Metrics & structured event emission integration beyond console logger.
- Tie-break enhancements for prioritization.

## Conventions

- Pure helpers kept side-effect free.
- In-memory data stores reset per test instantiation.
- Errors: simple `Error` with keywords (`duplicate`, `NOT_FOUND`, `rationale`).

## Usage

```ts
import { InMemoryKPIService } from '@neonpro/core-services';

const kpis = new InMemoryKPIService();
await kpis.register({
  id: 'KPI-LAT',
  name: 'Latency',
  target: 200,
  direction: 'lower-better',
  unit: 'ms',
});
const result = await kpis.evaluate('KPI-LAT', { value: 250 });
```

## Quality Gates (Met)

- All governance tests (contract, scenario, unit, placeholder) passing locally via `pnpm --filter @neonpro/core-services test` or inside package with `pnpm test`.
- Minimal implementation honoring KISS & YAGNI for Phase 1.

---

_Last updated: autogenerated Phase 1 TDD completion._
