// Prisma schema (skeleton) for NeonPro
// Docs: https://www.prisma.io/docs

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Healthcare Models - Matching actual database structure

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  clinics      Clinic[]
  auditTrails  AuditTrail[]
  auditLogs    AuditLog[]
  escalations  EscalationWorkflow[]
  operationStates OperationState[]
  googleCalendarIntegrations GoogleCalendarIntegration[]

  @@map("users")
}

model Clinic {
  id        String    @id @default(uuid())
  name      String
  ownerId   String    @map("owner_id")
  owner     User      @relation(fields: [ownerId], references: [id])
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  patients          Patient[]
  appointments      Appointment[]
  professionals     Professional[]
  consentRecords    ConsentRecord[]
  auditTrails       AuditTrail[]
  auditLogs         AuditLog[]
  riskAssessments   RiskAssessment[]
  complianceStatus  ComplianceStatus[]
  serviceTypes      ServiceType[]
  serviceCategories ServiceCategory[]
  googleCalendarIntegrations GoogleCalendarIntegration[]

  @@map("clinics")
}

// Enhanced Patient model with Brazilian healthcare compliance and LGPD features
model Patient {
  id                           String    @id @default(uuid())
  clinicId                     String    @map("clinic_id")
  clinic                       Clinic    @relation(fields: [clinicId], references: [id])
  medicalRecordNumber          String    @map("medical_record_number")
  externalIds                  Json?     @map("external_ids")
  givenNames                   String[]  @map("given_names")
  familyName                   String    @map("family_name")
  fullName                     String    @map("full_name")
  preferredName                String?   @map("preferred_name")
  phonePrimary                 String?   @map("phone_primary")
  phoneSecondary               String?   @map("phone_secondary")
  email                        String?
  addressLine1                 String?   @map("address_line1")
  addressLine2                 String?   @map("address_line2")
  city                         String?
  state                        String?
  postalCode                   String?   @map("postal_code")
  country                      String?   @default("BR")
  birthDate                    DateTime? @map("birth_date") @db.Date
  gender                       String?
  maritalStatus                String?   @map("marital_status")
  isActive                     Boolean?  @default(true) @map("is_active")
  deceasedIndicator            Boolean?  @default(false) @map("deceased_indicator")
  deceasedDate                 DateTime? @map("deceased_date") @db.Date

  // Brazilian Identity Fields (Required for LGPD compliance)
  cpf                          String?   @unique // Brazilian national identifier
  rg                           String?   // Brazilian state identifier
  rgIssuingOrgan               String?   @map("rg_issuing_organ") // RG issuing authority
  cns                          String?   @unique // Cartão Nacional de Saúde (Brazilian health card)
  passportNumber               String?   @map("passport_number")
  
  // LGPD Compliance Fields
  dataConsentStatus            String?   @default("pending") @map("data_consent_status") // pending, given, withdrawn, expired
  dataConsentDate              DateTime? @map("data_consent_date")
  dataConsentVersion           String?   @map("data_consent_version") // Version of consent terms
  dataRetentionUntil           DateTime? @map("data_retention_until") @db.Date
  dataAnonymizedAt             DateTime? @map("data_anonymized_at") // When data was anonymized
  dataAnonymizationScheduled   DateTime? @map("data_anonymization_scheduled") @db.Date // Scheduled anonymization
  dataProcessingPurpose        String[]  @map("data_processing_purpose") // Specific purposes for data processing
  dataSource                   String?   @default("manual") @map("data_source")
  sensitiveDataConsent         Json?     @map("sensitive_data_consent") // Granular consent for sensitive data
  lgpdConsentGiven             Boolean   @default(false) @map("lgpd_consent_given")
  lgpdConsentVersion           String?   @map("lgpd_consent_version")
  lgpdWithdrawalHistory        Json[]    @map("lgpd_withdrawal_history") // History of consent withdrawals
  dataSharingConsent           Json?     @map("data_sharing_consent")
  marketingConsent             Boolean?  @default(false) @map("marketing_consent")
  researchConsent              Boolean?  @default(false) @map("research_consent")
  rightToForgetRequested       Boolean?  @default(false) @map("right_to_forget_requested")
  rightToForgetRequestDate     DateTime? @map("right_to_forget_request_date")
  dataPortabilityRequested     Boolean?  @default(false) @map("data_portability_requested")
  
  // Healthcare-specific fields
  preferredContactMethod       String?   @default("phone") @map("preferred_contact_method")
  bloodType                    String?   @map("blood_type")
  allergies                    String[]
  chronicConditions            String[]  @map("chronic_conditions")
  currentMedications           String[]  @map("current_medications")
  
  // Brazilian Health Insurance
  insuranceProvider            String?   @map("insurance_provider")
  insuranceNumber              String?   @map("insurance_number")
  insurancePlan                String?   @map("insurance_plan")
  susCardNumber                String?   @map("sus_card_number") // Brazilian public health system card
  planOperatoraAns             String?   @map("plan_operadora_ans") // ANS operator code
  
  // Emergency contact
  emergencyContactName         String?   @map("emergency_contact_name")
  emergencyContactPhone        String?   @map("emergency_contact_phone")
  emergencyContactRelationship String?   @map("emergency_contact_relationship")
  emergencyContactCpf          String?   @map("emergency_contact_cpf")
  
  // AI-driven no-show prediction
  noShowRiskScore              Int?      @default(0) @map("no_show_risk_score") // 0-100 risk score
  lastNoShowDate               DateTime? @map("last_no_show_date")
  totalNoShows                 Int?      @default(0) @map("total_no_shows")
  totalAppointments            Int?      @default(0) @map("total_appointments")
  noShowPredictionFeatures     Json?     @map("no_show_prediction_features") // ML features for prediction
  behavioralPatterns           Json?     @map("behavioral_patterns") // Patient behavior analysis
  
  // Communication and preferences
  preferredAppointmentTime     String[]  @map("preferred_appointment_time")
  communicationPreferences     Json?     @map("communication_preferences")
  languagePreference           String?   @default("pt-BR") @map("language_preference")
  accessibilityNeeds           String[]  @map("accessibility_needs")
  
  // Administrative fields
  patientStatus                String?   @default("active") @map("patient_status")
  registrationSource           String?   @default("manual") @map("registration_source")
  lastVisitDate                DateTime? @map("last_visit_date")
  nextAppointmentDate          DateTime? @map("next_appointment_date")
  patientNotes                 String?   @map("patient_notes")
  nationality                  String?   @default("brasileira")
  primaryDoctorId              String?   @map("primary_doctor_id")
  
  // Audit and control fields
  createdAt                    DateTime? @default(now()) @map("created_at")
  updatedAt                    DateTime? @default(now()) @map("updated_at")
  createdBy                    String?   @map("created_by")
  updatedBy                    String?   @map("updated_by")
  photoUrl                     String?   @map("photo_url")

  // Relations
  appointments          Appointment[]
  consentRecords        ConsentRecord[]
  lgpdConsentHistory    LGPDConsent[]
  auditTrails           AuditTrail[]
  auditLogs             AuditLog[]
  telemedicineSessions  TelemedicineSession[]

  // Database indexes for performance
  @@index([clinicId, isActive])
  @@index([cpf])
  @@index([cns])
  @@index([dataConsentStatus])
  @@index([noShowRiskScore])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([lastVisitDate])
  @@map("patients")
}

// Enhanced Appointment model with Brazilian healthcare compliance and AI-driven no-show prediction
model Appointment {
  id                     String    @id @default(uuid())
  clinicId               String    @map("clinic_id")
  clinic                 Clinic    @relation(fields: [clinicId], references: [id])
  patientId              String    @map("patient_id")
  patient                Patient   @relation(fields: [patientId], references: [id])
  professionalId         String    @map("professional_id")
  professional           Professional @relation(fields: [professionalId], references: [id])
  serviceTypeId          String    @map("service_type_id")
  serviceType            ServiceType @relation("ServiceTypeAppointments", fields: [serviceTypeId], references: [id])
  
  // Appointment scheduling
  status                 String?   @default("scheduled") // scheduled, confirmed, in_progress, completed, cancelled, no_show
  appointmentType        String?   @default("in_person") @map("appointment_type") // in_person, telemedicine, hybrid
  scheduledDate          DateTime? @map("scheduled_date") // For backward compatibility
  startTime              DateTime  @map("start_time")
  endTime                DateTime  @map("end_time")
  timeZone               String?   @default("America/Sao_Paulo") @map("time_zone")
  duration               Int?      @map("duration") // Duration in minutes
  priority               EscalationPriority? @default(LOW) // Use enum instead of int
  treatmentType          String?   @map("treatment_type") // Type of treatment/procedure
  phone                  String?   @map("phone") // Contact phone for appointment
  
  // Brazilian healthcare compliance (TUSS codes and CFM)
  tussCode               String?   @map("tuss_code") // Terminologia Unificada da Saúde Suplementar
  tussProcedureName      String?   @map("tuss_procedure_name")
  cfmSpecialtyCode       String?   @map("cfm_specialty_code") // CFM medical specialty code
  cfmProfessionalCrm     String?   @map("cfm_professional_crm") // Professional CRM number
  cfmValidationStatus    String?   @default("pending") @map("cfm_validation_status") // pending, validated, rejected
  cfmValidatedAt         DateTime? @map("cfm_validated_at")
  anvisaCompliant        Boolean?  @default(true) @map("anvisa_compliant")
  anvisaProtocolNumber   String?   @map("anvisa_protocol_number")
  
  // AI-driven no-show prediction
  noShowRiskScore        Int?      @default(0) @map("no_show_risk_score") // 0-100 AI-calculated risk
  noShowPredictionModel  String?   @map("no_show_prediction_model") // Model version used
  noShowRiskFactors      Json?     @map("no_show_risk_factors") // Contributing factors
  noShowPredictedAt      DateTime? @map("no_show_predicted_at")
  noShowActualOutcome    Boolean?  @map("no_show_actual_outcome") // For model training
  noShowPreventionActions String[] @map("no_show_prevention_actions") // Actions taken to prevent no-show
  
  // Patient engagement and confirmation
  patientConfirmed       Boolean?  @default(false) @map("patient_confirmed")
  patientConfirmedAt     DateTime? @map("patient_confirmed_at")
  reminderSentAt         DateTime? @map("reminder_sent_at")
  confirmationSentAt     DateTime? @map("confirmation_sent_at")
  whatsappReminderSent   Boolean?  @default(false) @map("whatsapp_reminder_sent")
  smsReminderSent        Boolean?  @default(false) @map("sms_reminder_sent")
  emailReminderSent      Boolean?  @default(false) @map("email_reminder_sent")
  lastReminderSentAt     DateTime? @map("last_reminder_sent_at")
  reminderCount          Int?      @default(0) @map("reminder_count")
  
  // Clinical information
  chiefComplaint         String?   @map("chief_complaint") // Main reason for visit
  clinicalProtocol       String?   @map("clinical_protocol") // Protocol being followed
  priorAuthRequired      Boolean?  @default(false) @map("prior_auth_required")
  priorAuthNumber        String?   @map("prior_auth_number")
  priorAuthStatus        String?   @map("prior_auth_status")
  
  // Location and logistics
  roomId                 String?   @map("room_id")
  appointmentLocation    String?   @map("appointment_location") // Physical or virtual location
  checkInTime            DateTime? @map("check_in_time")
  checkOutTime           DateTime? @map("check_out_time")
  waitingTime            Int?      @map("waiting_time") // Minutes patient waited
  actualStartTime        DateTime? @map("actual_start_time")
  actualEndTime          DateTime? @map("actual_end_time")
  
  // Real-time subscription support
  subscriptionChannels   String[]  @map("subscription_channels") // Channels for real-time updates
  lastUpdatedChannel     String?   @map("last_updated_channel")
  realTimeUpdateEnabled  Boolean?  @default(true) @map("real_time_update_enabled")
  
  // Notes and documentation
  notes                  String?   // Patient-visible notes
  internalNotes          String?   @map("internal_notes") // Staff-only notes
  clinicalNotes          String?   @map("clinical_notes") // Clinical documentation
  followUpRequired       Boolean?  @default(false) @map("follow_up_required")
  followUpDate           DateTime? @map("follow_up_date")
  followUpInstructions   String?   @map("follow_up_instructions")
  
  // Financial and billing
  estimatedCost          Decimal?  @map("estimated_cost") @db.Decimal(10, 2)
  actualCost             Decimal?  @map("actual_cost") @db.Decimal(10, 2)
  paymentStatus          String?   @default("pending") @map("payment_status")
  insuranceCovered       Boolean?  @map("insurance_covered")
  copayAmount            Decimal?  @map("copay_amount") @db.Decimal(10, 2)
  
  // Cancellation and rescheduling
  rescheduleCount        Int?      @default(0) @map("reschedule_count")
  lastRescheduledAt      DateTime? @map("last_rescheduled_at")
  rescheduledBy          String?   @map("rescheduled_by")
  reschedulingReason     String?   @map("rescheduling_reason")
  cancelledAt            DateTime? @map("cancelled_at")
  cancelledBy            String?   @map("cancelled_by")
  cancellationReason     String?   @map("cancellation_reason")
  cancellationFee        Decimal?  @map("cancellation_fee") @db.Decimal(10, 2)
  
  // Quality and satisfaction
  patientSatisfactionScore Int?    @map("patient_satisfaction_score") // 1-5 rating
  patientFeedback        String?   @map("patient_feedback")
  serviceQualityScore    Int?      @map("service_quality_score")
  
  // Audit and control
  createdAt              DateTime? @default(now()) @map("created_at")
  updatedAt              DateTime? @default(now()) @map("updated_at")
  createdBy              String    @map("created_by")
  updatedBy              String?   @map("updated_by")
  version                Int?      @default(1) // For optimistic locking

  // Relations
  telemedicineSession    TelemedicineSession?
  googleCalendarEvent    GoogleCalendarEvent?

  // Indexes for performance optimization
  @@index([clinicId, startTime])
  @@index([patientId, startTime])
  @@index([professionalId, startTime])
  @@index([status, startTime])
  @@index([noShowRiskScore])
  @@index([tussCode])
  @@index([cfmValidationStatus])
  @@index([appointmentType])
  @@index([priority, startTime])
  @@index([createdAt])
  @@index([updatedAt])
  @@map("appointments")
}

// TelemedicineSession model with CFM compliance and NGS2 security standards
model TelemedicineSession {
  id                        String    @id @default(uuid())
  appointmentId             String    @unique @map("appointment_id")
  appointment               Appointment @relation(fields: [appointmentId], references: [id])
  patientId                 String    @map("patient_id")
  patient                   Patient   @relation(fields: [patientId], references: [id])
  clinicId                  String    @map("clinic_id")
  
  // CFM (Conselho Federal de Medicina) Compliance
  cfmResolution2314Compliant Boolean  @default(true) @map("cfm_resolution_2314_compliant")
  cfmProfessionalCrm         String   @map("cfm_professional_crm") // Professional CRM number
  cfmProfessionalState       String   @map("cfm_professional_state") // CRM state
  cfmSpecialtyCode           String?  @map("cfm_specialty_code")
  cfmEthicsCompliance        Boolean  @default(true) @map("cfm_ethics_compliance")
  cfmProtocolNumber          String?  @map("cfm_protocol_number")
  cfmValidationStatus        String   @default("pending") @map("cfm_validation_status") // pending, validated, rejected
  cfmValidatedAt             DateTime? @map("cfm_validated_at")
  cfmValidatedBy             String?  @map("cfm_validated_by")
  
  // ICP-Brasil Digital Certificate Validation
  icpBrasilCertRequired      Boolean  @default(true) @map("icp_brasil_cert_required")
  icpBrasilCertPresent       Boolean  @default(false) @map("icp_brasil_cert_present")
  icpBrasilCertSerialNumber  String?  @map("icp_brasil_cert_serial_number")
  icpBrasilCertFingerprint   String?  @map("icp_brasil_cert_fingerprint")
  icpBrasilCertValidFrom     DateTime? @map("icp_brasil_cert_valid_from")
  icpBrasilCertValidTo       DateTime? @map("icp_brasil_cert_valid_to")
  icpBrasilCertAuthority     String?  @map("icp_brasil_cert_authority")
  icpBrasilCertValidated     Boolean  @default(false) @map("icp_brasil_cert_validated")
  icpBrasilCertValidationChain Json?  @map("icp_brasil_cert_validation_chain")
  
  // NGS2 (Norma Geral de Segurança de Nível 2) Security Standards
  ngs2SecurityLevel          String   @default("level_2") @map("ngs2_security_level") // level_1, level_2, level_3
  ngs2EncryptionStandard     String   @default("AES_256") @map("ngs2_encryption_standard")
  ngs2KeyManagement          Json     @map("ngs2_key_management") // Key management details
  ngs2AccessControl          Json     @map("ngs2_access_control") // Access control matrix
  ngs2AuditTrail             Json[]   @default([]) @map("ngs2_audit_trail") // Security audit events
  ngs2ComplianceChecked      Boolean  @default(false) @map("ngs2_compliance_checked")
  ngs2ComplianceScore        Int?     @map("ngs2_compliance_score") // 0-100 compliance score
  ngs2LastSecurityAudit      DateTime? @map("ngs2_last_security_audit")
  
  // Session Management and Encryption
  sessionToken               String   @unique @map("session_token")
  sessionEncryptionKey       String   @map("session_encryption_key") // Encrypted session key
  sessionStartTime           DateTime @map("session_start_time")
  sessionEndTime             DateTime? @map("session_end_time")
  sessionDuration            Int?     @map("session_duration") // Duration in seconds
  sessionStatus              String   @default("scheduled") @map("session_status") // scheduled, active, completed, cancelled, failed
  connectionQuality          String?  @map("connection_quality") // excellent, good, fair, poor
  
  // Video/Audio Technical Details
  videoCodec                 String?  @map("video_codec")
  audioCodec                 String?  @map("audio_codec")
  bandwidth                  String?  @map("bandwidth")
  resolution                 String?  @map("resolution")
  frameRate                  Int?     @map("frame_rate")
  latency                    Int?     @map("latency") // Milliseconds
  packetLoss                 Float?   @map("packet_loss") // Percentage
  
  // Recording and Consent Management
  recordingEnabled           Boolean  @default(false) @map("recording_enabled")
  recordingConsent           Boolean  @default(false) @map("recording_consent")
  recordingConsentGivenAt    DateTime? @map("recording_consent_given_at")
  recordingConsentMethod     String?  @map("recording_consent_method") // verbal, digital, written
  recordingFileHash          String?  @map("recording_file_hash") // SHA-256 hash of recording
  recordingStorageLocation   String?  @map("recording_storage_location")
  recordingRetentionUntil    DateTime? @map("recording_retention_until")
  recordingEncrypted         Boolean  @default(true) @map("recording_encrypted")
  recordingAccessLog         Json[]   @default([]) @map("recording_access_log")
  
  // LGPD and Data Protection
  lgpdCompliant              Boolean  @default(true) @map("lgpd_compliant")
  lgpdConsentId              String?  @map("lgpd_consent_id") // Reference to LGPDConsent record
  dataProcessingPurpose      String[] @map("data_processing_purpose")
  dataRetentionPeriod        String   @map("data_retention_period")
  dataAnonymizationScheduled DateTime? @map("data_anonymization_scheduled")
  sensitiveDataProcessed     Boolean  @default(true) @map("sensitive_data_processed")
  crossBorderDataTransfer    Boolean  @default(false) @map("cross_border_data_transfer")
  
  // Platform and Device Information
  patientPlatform            String?  @map("patient_platform") // web, mobile_ios, mobile_android, desktop
  patientDeviceInfo          Json?    @map("patient_device_info")
  patientIpAddress           String?  @map("patient_ip_address")
  patientUserAgent           String?  @map("patient_user_agent")
  professionalPlatform       String?  @map("professional_platform")
  professionalDeviceInfo     Json?    @map("professional_device_info")
  professionalIpAddress      String?  @map("professional_ip_address")
  
  // Clinical Documentation
  clinicalNotes              String?  @map("clinical_notes")
  diagnosisCode              String?  @map("diagnosis_code") // ICD-10 or similar
  treatmentPlan              String?  @map("treatment_plan")
  prescriptions              Json[]   @default([]) @map("prescriptions")
  followUpRequired           Boolean  @default(false) @map("follow_up_required")
  followUpInstructions       String?  @map("follow_up_instructions")
  
  // Quality Metrics
  patientSatisfaction        Int?     @map("patient_satisfaction") // 1-5 rating
  technicalQualityScore      Int?     @map("technical_quality_score") // 1-5 rating
  clinicalQualityScore       Int?     @map("clinical_quality_score") // 1-5 rating
  overallSessionRating       Int?     @map("overall_session_rating") // 1-5 rating
  
  // Billing and Insurance
  insurancePreAuthorization  String?  @map("insurance_pre_authorization")
  billingCode                String?  @map("billing_code")
  sessionCost                Decimal? @map("session_cost") @db.Decimal(10, 2)
  insuranceCoverage          Decimal? @map("insurance_coverage") @db.Decimal(10, 2)
  patientResponsibility      Decimal? @map("patient_responsibility") @db.Decimal(10, 2)
  
  // Error Handling and Troubleshooting
  technicalIssues            Json[]   @default([]) @map("technical_issues")
  connectionFailures         Int      @default(0) @map("connection_failures")
  lastErrorMessage           String?  @map("last_error_message")
  troubleshootingLog         Json[]   @default([]) @map("troubleshooting_log")
  
  // Compliance and Audit
  regulatoryFrameworks       String[] @map("regulatory_frameworks") // CFM, ANVISA, LGPD, etc.
  complianceValidatedAt      DateTime? @map("compliance_validated_at")
  complianceValidatedBy      String?  @map("compliance_validated_by")
  auditEvents                Json[]   @default([]) @map("audit_events")
  securityIncidents          Json[]   @default([]) @map("security_incidents")
  
  // Metadata
  sessionMetadata            Json?    @map("session_metadata")
  internalNotes              String?  @map("internal_notes")
  tags                       String[] @default([])
  
  createdAt                  DateTime @default(now()) @map("created_at")
  updatedAt                  DateTime @updatedAt @map("updated_at")
  createdBy                  String?  @map("created_by")
  updatedBy                  String?  @map("updated_by")

  // Indexes for performance and compliance
  @@index([patientId, sessionStartTime])
  @@index([cfmProfessionalCrm])
  @@index([cfmValidationStatus])
  @@index([icpBrasilCertValidated])
  @@index([ngs2ComplianceScore])
  @@index([sessionStatus, sessionStartTime])
  @@index([lgpdCompliant])
  @@index([recordingEnabled])
  @@index([createdAt])
  @@map("telemedicine_sessions")
}

// Enhanced Professional model for aesthetic health professionals
model Professional {
  id                   String    @id @default(uuid())
  clinicId             String    @map("clinic_id")
  clinic               Clinic    @relation(fields: [clinicId], references: [id])
  userId               String?   @map("user_id")
  fullName             String    @map("full_name")
  specialization       String?
  licenseNumber        String?   @map("license_number")
  phone                String?
  email                String?
  color                String?   @default("#10B981")
  isActive             Boolean?  @default(true) @map("is_active")
  canWorkWeekends      Boolean?  @default(false) @map("can_work_weekends")
  defaultStartTime     DateTime? @map("default_start_time") @db.Time
  defaultEndTime       DateTime? @map("default_end_time") @db.Time
  defaultBreakStart    DateTime? @map("default_break_start") @db.Time
  defaultBreakEnd      DateTime? @map("default_break_end") @db.Time
  serviceTypeIds       String[]  @map("service_type_ids")
  createdAt            DateTime? @default(now()) @map("created_at")
  updatedAt            DateTime? @default(now()) @map("updated_at")
  createdBy            String?   @map("created_by")
  updatedBy            String?   @map("updated_by")

  // Aesthetic professional license validation
  councilType           String?   @map("council_type") // CRM, COREN, CFF, CNEP
  councilLicense        String?   @map("council_license") // Full license number
  councilState          String?   @map("council_state") // Brazilian state code
  councilValidation     String?   @default("pending") @map("council_validation") // pending, validated, rejected
  licenseExpiryDate    DateTime? @map("license_expiry_date") @db.Date
  
  // Aesthetic medicine specializations
  aestheticSpecializations String[] @map("aesthetic_specializations") // ["botox", "fillers", "laser", "chemical_peels", "facial_harmonization"]
  certificationLevels    Json?     @map("certification_levels") // Certification details for different procedures
  trainingHistory        Json?     @map("training_history") // Aesthetic procedure training records
  
  // Professional availability and preferences
  preferredProcedures   String[]  @map("preferred_procedures") // Procedures this professional prefers
  maxDailyAppointments  Int?      @default(20) @map("max_daily_appointments")
  appointmentBuffer     Int?      @default(15) @map("appointment_buffer") // Minutes between appointments

  appointments         Appointment[]

  @@map("professionals")
}

// LGPD Consent Record model matching database structure
model ConsentRecord {
  id                String    @id @default(uuid())
  patientId         String    @map("patient_id")
  patient           Patient   @relation(fields: [patientId], references: [id])
  clinicId          String    @map("clinic_id")
  clinic            Clinic    @relation(fields: [clinicId], references: [id])
  consentType       String    @map("consent_type")
  purpose           String
  legalBasis        String    @map("legal_basis")
  status            String    @default("pending")
  givenAt           DateTime? @map("given_at")
  withdrawnAt       DateTime? @map("withdrawn_at")
  expiresAt         DateTime? @map("expires_at")
  collectionMethod  String    @map("collection_method")
  ipAddress         String?   @map("ip_address")
  userAgent         String?   @map("user_agent")
  evidence          Json?     @default("{}")
  dataCategories    String[]  @map("data_categories")
  createdAt         DateTime? @default(now()) @map("created_at")
  updatedAt         DateTime? @default(now()) @map("updated_at")

  @@map("consent_records")
}

// Enhanced LGPD Consent model with cryptographic proof and legal framework
model LGPDConsent {
  id                       String    @id @default(uuid())
  patientId                String    @map("patient_id")
  patient                  Patient   @relation(fields: [patientId], references: [id])
  clinicId                 String    @map("clinic_id")
  
  // Legal framework fields
  legalBasis               String    @map("legal_basis") // Art. 7º, 11º LGPD: consent, contract, legitimate_interest, etc.
  processingPurpose        String    @map("processing_purpose") // Specific purpose for data processing
  dataCategories           String[]  @map("data_categories") // Types of data being processed
  dataSubjects             String[]  @map("data_subjects") // Who the data relates to
  retentionPeriod          String    @map("retention_period") // How long data will be kept
  retentionJustification   String?   @map("retention_justification") // Legal justification for retention
  
  // Consent lifecycle management
  consentType              String    @map("consent_type") // explicit, implicit, withdrawn, revoked
  consentStatus            String    @default("pending") @map("consent_status") // pending, active, withdrawn, expired, revoked
  consentVersion           String    @map("consent_version") // Version of consent terms
  consentText              String    @map("consent_text") // Full text of consent given
  consentLanguage          String    @default("pt-BR") @map("consent_language")
  
  // Timestamps for lifecycle
  requestedAt              DateTime  @default(now()) @map("requested_at")
  givenAt                  DateTime? @map("given_at")
  withdrawnAt              DateTime? @map("withdrawn_at")
  expiredAt                DateTime? @map("expired_at")
  revokedAt                DateTime? @map("revoked_at")
  lastConfirmedAt          DateTime? @map("last_confirmed_at")
  scheduledExpiryAt        DateTime? @map("scheduled_expiry_at")
  
  // Cryptographic proof and validation
  consentHash              String    @map("consent_hash") // SHA-256 hash of consent + patient data
  digitalSignature         String?   @map("digital_signature") // Digital signature if available
  timestampToken           String?   @map("timestamp_token") // Cryptographic timestamp
  blockchainTxHash         String?   @map("blockchain_tx_hash") // Optional blockchain proof
  integrityChecksum        String    @map("integrity_checksum") // Checksum for data integrity
  cryptographicProof       Json      @map("cryptographic_proof") // Additional crypto proofs
  
  // Collection context
  collectionMethod         String    @map("collection_method") // web_form, mobile_app, in_person, phone, etc.
  collectionLocation       String?   @map("collection_location") // Physical or digital location
  collectorUserId          String?   @map("collector_user_id") // Who collected the consent
  collectorRole            String?   @map("collector_role") // Role of consent collector
  
  // Technical context
  ipAddress                String?   @map("ip_address")
  userAgent                String?   @map("user_agent")
  sessionId                String?   @map("session_id")
  deviceFingerprint        String?   @map("device_fingerprint")
  geolocation              Json?     @map("geolocation") // Lat/lng if available
  
  // Legal compliance tracking
  gdprCompliant            Boolean   @default(true) @map("gdpr_compliant")
  lgpdCompliant            Boolean   @default(true) @map("lgpd_compliant")
  ccpaCompliant            Boolean   @default(false) @map("ccpa_compliant")
  hipaaCompliant           Boolean   @default(true) @map("hipaa_compliant")
  regulatoryFrameworks     String[]  @map("regulatory_frameworks") // Applicable legal frameworks
  
  // Withdrawal and revocation
  withdrawalReason         String?   @map("withdrawal_reason")
  withdrawalMethod         String?   @map("withdrawal_method") // email, phone, in_person, etc.
  withdrawalConfirmed      Boolean   @default(false) @map("withdrawal_confirmed")
  withdrawalProcessedAt    DateTime? @map("withdrawal_processed_at")
  
  // Data subject rights tracking
  dataPortabilityGranted   Boolean   @default(false) @map("data_portability_granted")
  dataErasureRequested     Boolean   @default(false) @map("data_erasure_requested")
  dataRectificationRequested Boolean @default(false) @map("data_rectification_requested")
  dataProcessingRestricted Boolean   @default(false) @map("data_processing_restricted")
  
  // Audit and evidence
  evidenceDocuments        Json[]    @default([]) @map("evidence_documents") // Supporting evidence
  auditLog                 Json[]    @default([]) @map("audit_log") // Changes and actions
  legalReviewStatus        String?   @default("pending") @map("legal_review_status") // pending, approved, rejected
  legalReviewedBy          String?   @map("legal_reviewed_by")
  legalReviewedAt          DateTime? @map("legal_reviewed_at")
  legalNotes               String?   @map("legal_notes")
  
  // Metadata and versioning
  parentConsentId          String?   @map("parent_consent_id") // If this is an update/revision
  childConsentIds          String[]  @map("child_consent_ids") // Subsequent revisions
  migrationSource          String?   @map("migration_source") // If migrated from old system
  internalNotes            String?   @map("internal_notes")
  tags                     String[]  @default([]) // For categorization
  
  createdAt                DateTime  @default(now()) @map("created_at")
  updatedAt                DateTime  @updatedAt @map("updated_at")
  createdBy                String?   @map("created_by")
  updatedBy                String?   @map("updated_by")

  // Indexes for performance and compliance queries
  @@index([patientId, consentStatus])
  @@index([clinicId, consentStatus])
  @@index([legalBasis, consentStatus])
  @@index([consentHash])
  @@index([givenAt])
  @@index([withdrawnAt])
  @@index([expiredAt])
  @@index([scheduledExpiryAt])
  @@index([createdAt])
  @@unique([consentHash]) // Ensure hash uniqueness for integrity
  @@map("lgpd_consents")
}

// Governance Models

enum AuditAction {
  VIEW
  CREATE
  READ
  UPDATE
  DELETE
  EXPORT
  LOGIN
  LOGOUT
  AI_CHAT
  AI_PREDICTION
  AI_ANALYSIS
  AI_RECOMMENDATION
}

enum ResourceType {
  PATIENT_RECORD
  PATIENT_DATA
  PATIENT_CONSENT
  APPOINTMENT
  COMMUNICATION
  AI_PREDICTION
  AI_MODEL_PERFORMANCE
  TELEMEDICINE_SESSION
  PRESCRIPTION
  COMPLIANCE_REPORT
  REPORT
  SYSTEM_CONFIG
  USER_ACCOUNT
}

enum AuditStatus {
  SUCCESS
  FAILED
  FAILURE
  PARTIAL_SUCCESS
  BLOCKED
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}// HIPAA/LGPD Audit Trail - Critical for compliance
model AuditTrail {
  id             String      @id @default(uuid())
  userId         String      @map("user_id")
  user           User        @relation(fields: [userId], references: [id])
  clinicId       String?     @map("clinic_id")
  clinic         Clinic?     @relation(fields: [clinicId], references: [id])
  patientId      String?     @map("patient_id")
  patient        Patient?    @relation(fields: [patientId], references: [id])

  action         AuditAction
  resource       String      // What was accessed
  resourceType   ResourceType @map("resource_type")
  resourceId     String?     @map("resource_id") // ID of the accessed resource

  ipAddress      String      @map("ip_address")
  userAgent      String      @map("user_agent")
  sessionId      String?     @map("session_id")

  status         AuditStatus
  riskLevel      RiskLevel   @default(LOW) @map("risk_level")
  additionalInfo String?     @map("additional_info")

  createdAt      DateTime    @default(now()) @map("created_at")

  // Relations
  auditLogs      AuditLog[]

  @@index([userId, createdAt])
  @@index([clinicId, createdAt])
  @@index([patientId, createdAt])
  @@index([action, status])
  @@index([riskLevel, createdAt])
  @@map("audit_logs")
}

// Enhanced Audit Log for detailed compliance tracking
model AuditLog {
  id                String      @id @default(uuid())
  
  // Entity identification
  entityType        String      @map("entity_type") // Type of entity being audited
  entityId          String      @map("entity_id")   // ID of the entity being audited
  
  // Action details
  action            String      // Action performed
  actionType        String      @map("action_type") // CREATE, READ, UPDATE, DELETE, etc.
  
  // User context
  userId            String      @map("user_id")
  user              User        @relation(fields: [userId], references: [id])
  clinicId          String?     @map("clinic_id")
  clinic            Clinic?     @relation(fields: [clinicId], references: [id])
  patientId         String?     @map("patient_id")
  patient           Patient?    @relation(fields: [patientId], references: [id])
  
  // Request context
  requestId         String?     @map("request_id")    // Unique request identifier
  sessionId         String?     @map("session_id")    // Session identifier
  ipAddress         String      @map("ip_address")
  userAgent         String      @map("user_agent")
  
  // Data details
 OldData           Json?       @map("old_data")      // Data before change (for updates)
  NewData           Json?       @map("new_data")      // Data after change
  
  // Compliance and risk
  riskLevel         RiskLevel   @default(LOW) @map("risk_level")
  complianceStatus  String      @default("COMPLIANT") @map("compliance_status")
  violationType     String?     @map("violation_type")
  
  // Metadata
  details           Json?       // Additional audit details
  category          String?     // Audit category
  severity          String?     // Severity level
  
  // Timestamps
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")
  
  // Relations
  auditTrailId      String?     @map("audit_trail_id")
  auditTrail        AuditTrail? @relation(fields: [auditTrailId], references: [id])
  
  @@index([entityType, entityId])
  @@index([userId, createdAt])
  @@index([clinicId, createdAt])
  @@index([patientId, createdAt])
  @@index([action, createdAt])
  @@index([riskLevel, createdAt])
  @@index([complianceStatus, createdAt])
  @@map("audit_logs_detailed")
}enum KPIStatus {
  ACTIVE
  ARCHIVED
  PROVISIONAL
}

enum ComplianceFramework {
  HIPAA
  LGPD
  GDPR
  SOC2
}

enum ComplianceStatusEnum {
  COMPLIANT
  NON_COMPLIANT
  UNDER_REVIEW
  CRITICAL
}

// KPI Metrics for dashboard
model KPIMetric {
  id          String    @id @default(uuid())
  name        String
  description String?
  category    String    // e.g., "normalization", "quality", "compliance"
  
  currentValue Float
  targetValue  Float
  direction   String    // "higher_better", "lower_better", "target_exact"
  unit        String?   // "%", "count", "score", etc.
  
  status      KPIStatus @default(ACTIVE)
  threshold   Float?    // Warning threshold
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([status, category])
  @@index([createdAt])
}// Compliance Status Monitoring
model ComplianceStatus {
  id          String                @id @default(uuid())
  clinicId    String
  clinic      Clinic                @relation(fields: [clinicId], references: [id])
  
  framework   ComplianceFramework
  score       Float                 // Compliance score (0-100)
  status      ComplianceStatusEnum
  violations  Int                   @default(0)
  lastAudit   DateTime?
  nextAudit   DateTime?
  
  details     Json?                 // Additional compliance details
  
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  
  @@unique([clinicId, framework])
  @@index([status, framework])
}

// Risk Assessment and Management
model RiskAssessment {
  id              String     @id @default(uuid())
  clinicId        String
  clinic          Clinic     @relation(fields: [clinicId], references: [id])
  
  category        String     // "Security", "Privacy", "Operational", etc.
  title           String
  description     String
  severity        RiskLevel
  likelihood      RiskLevel
  impact          RiskLevel
  
  status          String     // "Open", "Mitigated", "Accepted", "Transferred"
  mitigation      String?    // Mitigation strategy
  owner           String?    // Risk owner
  dueDate         DateTime?
  
  metadata        Json?      // Additional risk data
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  @@index([severity, status])
  @@index([clinicId, status])
}enum AIModelStatus {
  ACTIVE
  INACTIVE
  TRAINING
  DEPRECATED
}

enum PolicyStatus {
  ACTIVE
  DRAFT
  ARCHIVED
  UNDER_REVIEW
}

enum EscalationPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum EscalationStatus {
  OPEN
  IN_PROGRESS
  ESCALATED
  RESOLVED
  CLOSED
}

enum HealthcareMetricType {
  CFM_COMPLIANCE_RATE
  ANVISA_AUDIT_SCORE
  LGPD_COMPLIANCE_SCORE
  PATIENT_SAFETY_INCIDENTS
  DATA_BREACH_INCIDENTS
  CONSENT_COMPLIANCE_RATE
  AVERAGE_RESPONSE_TIME
  ERROR_RATE
  SYSTEM_AVAILABILITY
  AUDIT_COMPLETION_RATE
}

enum HealthcareMetricStatus {
  COMPLIANT
  WARNING
  CRITICAL
  UNKNOWN
}

enum HealthcareMetricCategory {
  CFM
  ANVISA
  LGPD
  PERFORMANCE
  SAFETY
  AUDIT
}

// AI Governance and Model Performance
model AIGovernanceMetric {
  id                    String         @id @default(uuid())
  modelName             String
  modelVersion          String
  status                AIModelStatus  @default(ACTIVE)
  
  hallucinationRate     Float          // Percentage
  accuracyScore         Float          // 0-100
  biasScore             Float?         // Bias detection score
  complianceScore       Float          // Compliance with regulations
  
  requestsProcessed     Int            @default(0)
  averageResponseTime   Float?         // Milliseconds
  errorRate             Float          @default(0)
  
  lastTrainingDate      DateTime?
  modelSize             String?        // "7B", "13B", etc.
  
  metadata              Json?          // Additional model metadata
  
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  
  @@unique([modelName, modelVersion])
  @@index([status, hallucinationRate])
}// Policy Management
model PolicyManagement {
  id                 String        @id @default(uuid())
  name               String
  description        String
  category           String        // "Security", "Privacy", "Clinical", etc.
  framework          ComplianceFramework
  
  status             PolicyStatus  @default(DRAFT)
  version            String        @default("1.0")
  
  enforcementRate    Float         @default(0) // 0-100%
  violationCount     Int           @default(0)
  lastReview         DateTime?
  nextReview         DateTime?
  
  content            String        // Policy content/rules
  metadata           Json?         // Additional policy data
  
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  
  @@index([status, framework])
  @@index([category, status])
}

// Service Types - Healthcare services offered by clinics
model ServiceType {
  id               String    @id @default(uuid())
  name             String
  description      String?
  duration_minutes Int       @map("duration_minutes")
  price            Decimal   @db.Decimal(10, 2)
  is_active        Boolean   @default(true) @map("is_active")
  clinic_id        String          @map("clinic_id")
  clinic           Clinic          @relation(fields: [clinic_id], references: [id])
  category_id      String?         @map("category_id")
  category         ServiceCategory? @relation("CategoryServices", fields: [category_id], references: [id])
  created_at       DateTime        @default(now()) @map("created_at")
  updated_at       DateTime        @updatedAt @map("updated_at")

  // Relations
  appointments     Appointment[]   @relation("ServiceTypeAppointments")

  @@map("service_types")
  @@index([clinic_id])
  @@index([is_active])
  @@index([category_id])
}

// Service Categories for organizing services
model ServiceCategory {
  id           String        @id @default(uuid())
  name         String
  color        String        @default("#3B82F6") // Default blue color
  clinic_id    String        @map("clinic_id")
  clinic       Clinic        @relation(fields: [clinic_id], references: [id])
  created_at   DateTime      @default(now()) @map("created_at")
  updated_at   DateTime      @updatedAt @map("updated_at")

  // Relations
  services     ServiceType[] @relation("CategoryServices")

  @@map("service_categories")
  @@index([clinic_id])
}

// Escalation Workflow Management
model EscalationWorkflow {
  id              String              @id @default(uuid())
  userId          String
  user            User                @relation(fields: [userId], references: [id])

  title           String
  description     String
  category        String              // "Security", "Compliance", "Clinical", etc.
  source          String              // "compliance-audit", "risk-assessment", etc.
  
  priority        EscalationPriority
  status          EscalationStatus    @default(OPEN)
  
  assignedTo      String?             // Team or person assigned
  deadline        DateTime?
  escalatedAt     DateTime?
  resolvedAt      DateTime?
  
  responseTime    Int?                // Minutes to first response
  resolutionTime  Int?                // Minutes to resolution
  
  notes           String?
  metadata        Json?               // Additional escalation data
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  @@index([priority, status])
  @@index([status, deadline])
  @@index([assignedTo, status])
}

// Google Calendar Integration Models

model GoogleCalendarIntegration {
  id              String                @id @default(uuid())
  userId          String                @map("user_id")
  user            User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  clinicId        String                @map("clinic_id")
  clinic          Clinic                @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  
  accessToken     String                @map("access_token") @db.Text
  refreshToken    String?               @map("refresh_token") @db.Text
  expiresAt       DateTime?             @map("expires_at")
  scope           String
  tokenId         String                @map("token_id")
  
  // Configuration
  syncEnabled     Boolean               @default(true) @map("sync_enabled")
  autoSync        Boolean               @default(true) @map("auto_sync")
  bidirectional   Boolean               @default(true) @map("bidirectional")
  
  // Healthcare Compliance
  lgpdConsent     Boolean               @default(false) @map("lgpd_consent")
  consentDate     DateTime?             @map("consent_date")
  consentVersion  String                @default("1.0") @map("consent_version")
  
  // Sync Settings
  syncCalendarId  String                @map("sync_calendar_id")
  syncTimezone    String                @default("America/Sao_Paulo") @map("sync_timezone")
  
  // Error handling
  lastSyncAt      DateTime?             @map("last_sync_at")
  lastError       String?               @map("last_error") @db.Text
  errorCount      Int                   @default(0) @map("error_count")
  
  createdAt       DateTime              @default(now()) @map("created_at")
  updatedAt       DateTime              @updatedAt @map("updated_at")
  
  // Relations
  syncLogs        GoogleCalendarSyncLog[]
  
  @@unique([userId, clinicId])
  @@index([userId])
  @@index([clinicId])
  @@index([syncEnabled])
  @@map("google_calendar_integrations")
}

// Store Google Calendar event mappings for appointments
model GoogleCalendarEvent {
  id             String                   @id @default(uuid())
  appointmentId  String                   @map("appointment_id")
  appointment    Appointment              @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  
  googleEventId  String                   @map("google_event_id")
  calendarId     String                   @map("calendar_id")
  htmlLink       String?                  @map("html_link")
  
  // Sync status
  syncStatus     GoogleCalendarSyncStatus @default(SYNCED) @map("sync_status")
  lastSyncAt     DateTime                 @default(now()) @map("last_sync_at")
  
  // Conflict resolution
  isConflict     Boolean                  @default(false) @map("is_conflict")
  conflictType   String?                  @map("conflict_type")
  resolvedAt     DateTime?                @map("resolved_at")
  
  createdAt      DateTime                 @default(now()) @map("created_at")
  updatedAt      DateTime                 @updatedAt @map("updated_at")
  
  @@unique([appointmentId])
  @@index([googleEventId])
  @@index([syncStatus])
  @@map("google_calendar_events")
}

// Sync logs for audit and compliance
model GoogleCalendarSyncLog {
  id            String                   @id @default(uuid())
  integrationId String                   @map("integration_id")
  integration   GoogleCalendarIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  
  operation     GoogleCalendarOperation  @map("operation")
  direction     SyncDirection            @map("direction")
  
  // Event details
  appointmentId String?                  @map("appointment_id")
  eventId       String?                  @map("event_id")
  
  // Results
  status        SyncLogStatus            @default(SUCCESS) @map("status")
  error         String?                  @map("error") @db.Text
  responseTime  Int?                     @map("response_time") // ms
  
  // Compliance
  ipAddress     String?                  @map("ip_address")
  userAgent     String?                  @map("user_agent")
  
  createdAt     DateTime                 @default(now()) @map("created_at")
  
  @@index([integrationId, createdAt])
  @@index([status, createdAt])
  @@index([appointmentId])
  @@map("google_calendar_sync_logs")
}

// Enums for Google Calendar Integration
enum GoogleCalendarSyncStatus {
  SYNCED
  PENDING
  FAILED
  CONFLICT
  IGNORED
}

enum GoogleCalendarOperation {
  CREATE
  UPDATE
  DELETE
  SYNC
  REFRESH_TOKEN
}

enum SyncDirection {
  TO_GOOGLE
  FROM_GOOGLE
  BIDIRECTIONAL
}

// Usage counters for API and service monitoring
model UsageCounter {
  id               String    @id @default(uuid())
  
  // Entity being tracked
  entityType       String    // "api", "service", "user", "clinic", etc.
  entityId         String    // ID of the entity
  
  // Usage metrics
  dailyQueries     Int       @default(0) @map("daily_queries")
  monthlyQueries   Int       @default(0) @map("monthly_queries")
  
  // Performance metrics
  currentCostUsd   Float?    @map("current_cost_usd")
  averageLatencyMs Float?    @map("average_latency_ms")
  cacheHitRate    Float?    @map("cache_hit_rate")  // 0-100 percentage
  errorRate        Float?    @map("error_rate")     // 0-100 percentage
  
  // Time windows
  date             DateTime  @default(now())  // For daily aggregation
  month            String?   // For monthly aggregation (YYYY-MM format)
  
  // Metadata
  metadata         Json?     // Additional counter-specific data
  
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  @@unique([entityType, entityId, date])
  @@index([entityType, date])
  @@index([entityId, entityType])
  @@map("usage_counters")
}

enum SyncLogStatus {
  SUCCESS
  FAILED
  RETRYING
  IGNORED
}

// Operation State Management Models
model OperationState {
  id                    String    @id @default(uuid())
  operationId           String    @unique @map("operation_id")
  step                  String    // "intent", "confirm", "execute"
  status                String    // "pending", "processing", "completed", "failed"
  entity                String
  operation             String
  userId                String    @map("user_id")
  clinicId              String?   @map("clinic_id")
  sessionId             String?   @map("session_id")
  data                  Json?
  metadata              Json?
  errorMessage          String?   @map("error_message")
  aiValidationResult    Json?     @map("ai_validation_result")
  lgpdComplianceResult  Json?     @map("lgpd_compliance_result")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  completedAt           DateTime? @map("completed_at")
  
  user                  User      @relation(fields: [userId], references: [id])
  stateAudits           OperationStateAudit[]
  
  @@map("operation_states")
  @@index([operationId])
  @@index([userId])
  @@index([status])
  @@index([step])
  @@index([createdAt])
}

model OperationStateAudit {
  id               String   @id @default(uuid())
  operationStateId String   @map("operation_state_id")
  oldStatus        String?  @map("old_status")
  newStatus        String   @map("new_status")
  oldStep          String?  @map("old_step")
  newStep          String   @map("new_step")
  userId           String   @map("user_id")
  changeReason     String?  @map("change_reason")
  metadata         Json?
  createdAt        DateTime @default(now()) @map("created_at")
  
  operationState   OperationState @relation(fields: [operationStateId], references: [id], onDelete: Cascade)

  @@map("operation_state_audit")
  @@index([operationStateId])
  @@index([createdAt])
}

// =====================================
// AESTHETIC CLINIC MODELS
// =====================================

// Aesthetic Client Profile extending the base Patient model with specific aesthetic fields
model AestheticClientProfile {
  id                        String    @id @default(uuid())
  patientId                 String    @unique @map("patient_id")
  patient                   Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
  clinicId                  String    @map("clinic_id")
  clinic                    Clinic    @relation(fields: [clinicId], references: [id])

  // Personal information specific to aesthetic clients
  skinType                  String?   @map("skin_type") // oily, dry, combination, sensitive, normal
  skinTone                  String?   @map("skin_tone") // fair, light, medium, olive, brown, dark
  skinConcerns              String[]  @map("skin_concerns") // acne, aging, hyperpigmentation, etc.
  beautyGoals               String[]  @map("beauty_goals") // rejuvenation, hydration, toning, etc.
  aestheticHistory          Json?     @map("aesthetic_history") // Previous treatments and procedures

  // Treatment preferences
  preferredTreatments      String[]  @map("preferred_treatments")
  treatmentFrequency       String?   @map("treatment_frequency") // weekly, monthly, quarterly, yearly
  treatmentBudget           Decimal?  @map("treatment_budget") @db.Decimal(10, 2)
  painTolerance            String?   @map("pain_tolerance") // low, medium, high
  downtimeTolerance        String?   @map("downtime_tolerance") // none, minimal, moderate, high

  // Contact and communication preferences
  preferredCommunication    String    @default("whatsapp") @map("preferred_communication") // whatsapp, sms, email
  marketingConsent         Boolean   @default(false) @map("marketing_consent")
  photoUsageConsent        Boolean   @default(false) @map("photo_usage_consent")
  testimonialConsent       Boolean   @default(false) @map("testimonial_consent")

  // Financial information
  paymentMethod            String?   @map("payment_method") // cash, credit, installment, membership
  membershipStatus         String?   @default("none") @map("membership_status") // none, basic, premium, vip
  membershipExpiry        DateTime? @map("membership_expiry")
  loyaltyPoints            Int?      @default(0) @map("loyalty_points")
  totalSpent               Decimal?  @default(0) @map("total_spent") @db.Decimal(10, 2)

  // Retention and analytics
  retentionRiskScore       Int?      @default(0) @map("retention_risk_score") // 0-100
  lastVisitDate            DateTime? @map("last_visit_date")
  nextAppointmentDate      DateTime? @map("next_appointment_date")
  visitFrequency           Int?      @default(0) @map("visit_frequency") // visits per year
  satisfactionScore        Int?      @default(0) @map("satisfaction_score") // 1-5
  referralCount            Int?      @default(0) @map("referral_count")

  // LGPD compliance specific to aesthetic data
  aestheticDataConsent      Boolean   @default(false) @map("aesthetic_data_consent")
  beforeAfterPhotosConsent Boolean   @default(false) @map("before_after_photos_consent")
  treatmentDataConsent      Boolean   @default(false) @map("treatment_data_consent")
  dataRetentionPeriod      Int?      @default(365) @map("data_retention_period") // days

  createdAt                DateTime  @default(now()) @map("created_at")
  updatedAt                DateTime  @updatedAt @map("updated_at")
  createdBy                String    @map("created_by")
  updatedBy                String?   @map("updated_by")

  // Relations
  aestheticSessions         AestheticSession[]
  treatmentPlans           TreatmentPlan[]
  photoAssessments         PhotoAssessment[]
  financialTransactions     FinancialTransaction[]
  retentionRecords          ClientRetentionRecord[]

  @@map("aesthetic_client_profiles")
  @@index([patientId])
  @@index([clinicId])
  @@index([retentionRiskScore])
  @@index([membershipStatus])
  @@index([createdAt])
}

// Treatment Catalog for aesthetic procedures
model TreatmentCatalog {
  id                        String    @id @default(uuid())
  clinicId                  String    @map("clinic_id")
  clinic                    Clinic    @relation(fields: [clinicId], references: [id])

  // Basic treatment information
  name                      String
  description               String
  category                  String    @map("treatment_category") // facial, body, injectable, laser, etc.
  subcategory               String?   @map("treatment_subcategory")
  treatmentType             String    @map("treatment_type") // medical, cosmetic, wellness

  // ANVISA compliance
  anvisaRegistrationNumber   String?   @map("anvisa_registration_number")
  anvisaExpiryDate          DateTime? @map("anvisa_expiry_date")
  anvisaComplianceStatus     String    @default("pending") @map("anvisa_compliance_status") // pending, approved, rejected, expired
  anvisaApprovalDate        DateTime? @map("anvisa_approval_date")
  anvisaCertificateUrl      String?   @map("anvisa_certificate_url")

  // Treatment specifications
  duration                  Int       @map("duration_minutes") // in minutes
  sessionsRequired          Int?      @default(1) @map("sessions_required")
  sessionInterval           Int?      @map("session_interval_days") // days between sessions
  recoveryTime              Int?      @map("recovery_time_days") // recovery period in days
  painLevel                 Int?      @default(1) @map("pain_level") // 1-10 scale
  complexity                String    @default("low") @map("complexity") // low, medium, high

  // Pricing and financial information
  basePrice                 Decimal   @map("base_price") @db.Decimal(10, 2)
  currency                  String    @default("BRL")
  priceIncludes            String[]  @map("price_includes") // consultation, aftercare, etc.
  additionalCosts           Json?     @map("additional_costs") // optional add-ons and their prices
  discountAvailable        Boolean   @default(false) @map("discount_available")
  membershipDiscount        Decimal?  @map("membership_discount") @db.Decimal(5, 2) // percentage

  // Clinical information
  indications               String[]  @map("indications") // recommended for
  contraindications        String[]  @map("contraindications") // not recommended for
  risks                     String[]  @map("risks")
  sideEffects               String[]  @map("side_effects")
  expectedResults           String[]  @map("expected_results")
  maintenanceFrequency      String?   @map("maintenance_frequency") // how often to repeat

  // Equipment and materials
  equipmentUsed            String[]  @map("equipment_used")
  materialsUsed             String[]  @map("materials_used")
  brandNames                String[]  @map("brand_names")
  productCodes              String[]  @map("product_codes")

  // Professional requirements
  requiredQualifications    String[]  @map("required_qualifications")
  certificationRequired     Boolean   @default(false) @map("certification_required")
  supervisionRequired       Boolean   @default(false) @map("supervision_required")

  // Media and marketing
  treatmentImages           String[]  @map("treatment_images") // URLs to treatment images
  beforeAfterPhotos         String[]  @map("before_after_photos") // URLs to before/after photos
  videoUrls                 String[]  @map("video_urls") // demonstration videos
  descriptionVideoUrl       String?   @map("description_video_url")

  // Availability and scheduling
  isActive                  Boolean   @default(true) @map("is_active")
  isNewTreatment            Boolean   @default(false) @map("is_new_treatment")
  isPopular                 Boolean   @default(false) @map("is_popular")
  seasonalAvailability     Json?     @map("seasonal_availability") // seasonal restrictions
  maxSessionsPerDay         Int?      @map("max_sessions_per_day")

  // Analytics and performance
  timesPerformed            Int       @default(0) @map("times_performed")
  satisfactionScore        Decimal?  @map("satisfaction_score") @db.Decimal(3, 2) // average rating
  complicationRate          Decimal?  @map("complication_rate") @db.Decimal(5, 2) // percentage
  revenueGenerated          Decimal?  @default(0) @map("revenue_generated") @db.Decimal(12, 2)

  createdAt                DateTime  @default(now()) @map("created_at")
  updatedAt                DateTime  @updatedAt @map("updated_at")
  createdBy                String    @map("created_by")
  updatedBy                String?   @map("updated_by")

  // Relations
  aestheticSessions         AestheticSession[]
  treatmentPlanItems       TreatmentPlanItem[]

  @@map("treatment_catalog")
  @@index([clinicId])
  @@index([category])
  @@index([treatmentType])
  @@index([anvisaComplianceStatus])
  @@index([isActive])
  @@index([basePrice])
  @@index([createdAt])
  @@unique([clinicId, name])
}

// Aesthetic Treatment Sessions
model AestheticSession {
  id                        String    @id @default(uuid())
  appointmentId             String?   @unique @map("appointment_id")
  appointment               Appointment? @relation(fields: [appointmentId], references: [id])
  patientId                 String    @map("patient_id")
  patient                   Patient   @relation(fields: [patientId], references: [id])
  aestheticClientProfileId  String    @map("aesthetic_client_profile_id")
  aestheticClientProfile    AestheticClientProfile @relation(fields: [aestheticClientProfileId], references: [id])
  clinicId                  String    @map("clinic_id")
  clinic                    Clinic    @relation(fields: [clinicId], references: [id])
  professionalId            String    @map("professional_id")
  professional              Professional @relation(fields: [professionalId], references: [id])
  treatmentCatalogId        String    @map("treatment_catalog_id")
  treatmentCatalog          TreatmentCatalog @relation(fields: [treatmentCatalogId], references: [id])

  // Session details
  sessionNumber             Int       @map("session_number") // session number in treatment series
  totalSessions             Int?      @map("total_sessions") // total sessions in treatment plan
  sessionType               String    @default("regular") @map("session_type") // regular, follow_up, touch_up, emergency

  // Treatment parameters
  treatmentAreas            String[]  @map("treatment_areas") // face, neck, hands, etc.
  treatmentIntensity        String?   @map("treatment_intensity") // low, medium, high
  productUsed               String[]  @map("product_used")
  productBatch              String[]  @map("product_batch")
  equipmentSettings        Json?     @map("equipment_settings") // specific machine settings
  techniqueUsed             String?   @map("technique_used")

  // Before and after assessment
  beforeAssessment          Json?     @map("before_assessment") // pre-treatment evaluation
  afterAssessment           Json?     @map("after_assessment") // post-treatment evaluation
  immediateResults          String?   @map("immediate_results")
  expectedResults           String[]  @map("expected_results")

  // Clinical monitoring
  preTreatmentPhotos        String[]  @map("pre_treatment_photos")
  postTreatmentPhotos       String[]  @map("post_treatment_photos")
  skinConditionBefore       Json?     @map("skin_condition_before")
  skinConditionAfter       Json?     @map("skin_condition_after")
  painLevelReported         Int?      @map("pain_level_reported") // 1-10 scale
  sideEffectsExperienced    String[]  @map("side_effects_experienced")
  complications             String[]  @map("complications")

  // Session timeline
  startTime                 DateTime  @map("start_time")
  endTime                   DateTime  @map("end_time")
  actualDuration            Int?      @map("actual_duration_minutes")
  preparationTime           Int?      @map("preparation_time_minutes")
  recoveryTime              Int?      @map("recovery_time_minutes")

  // Follow-up and aftercare
  aftercareInstructions     String[]  @map("aftercare_instructions")
  followUpDate              DateTime? @map("follow_up_date")
  nextSessionDate           DateTime? @map("next_session_date")
  productsRecommended       String[]  @map("products_recommended")
  homeCareInstructions      String[]  @map("home_care_instructions")

  // Patient feedback
  patientSatisfaction      Int?      @map("patient_satisfaction") // 1-5 scale
  patientFeedback           String?   @map("patient_feedback")
  resultsVisibility         Int?      @map("results_visibility") // 1-5 scale (how visible results are)
  painToleranceReported    String?   @map("pain_tolerance_reported") // better/worse than expected

  // Financial information
  sessionPrice              Decimal   @map("session_price") @db.Decimal(10, 2)
  discountApplied           Decimal?  @map("discount_applied") @db.Decimal(10, 2)
  finalPrice                Decimal   @map("final_price") @db.Decimal(10, 2)
  paymentStatus             String    @default("pending") @map("payment_status") // pending, paid, partial, refunded
  paymentMethod             String?   @map("payment_method")

  // Compliance and documentation
  anvisaProtocolNumber      String?   @map("anvisa_protocol_number")
  cfmCompliance             Boolean   @default(true) @map("cfm_compliance")
  informedConsentSigned     Boolean   @default(false) @map("informed_consent_signed")
  consentDocumentUrl        String?   @map("consent_document_url")

  // Quality control
  qualityAssessment         String?   @map("quality_assessment") // excellent, good, fair, poor
  qualityNotes              String?   @map("quality_notes")
  peerReviewRequired        Boolean   @default(false) @map("peer_review_required")
  peerReviewCompleted       Boolean   @default(false) @map("peer_review_completed")
  reviewedByProfessionalId  String?   @map("reviewed_by_professional_id")

  // Status and tracking
  status                    String    @default("scheduled") @map("status") // scheduled, in_progress, completed, cancelled, no_show
  cancellationReason        String?   @map("cancellation_reason")
  rescheduledFrom           DateTime? @map("rescheduled_from")
  noShowReason             String?   @map("no_show_reason")

  createdAt                DateTime  @default(now()) @map("created_at")
  updatedAt                DateTime  @updatedAt @map("updated_at")
  createdBy                String    @map("created_by")
  updatedBy                String?   @map("updated_by")

  // Relations
  photoAssessments         PhotoAssessment[]

  @@map("aesthetic_sessions")
  @@index([appointmentId])
  @@index([patientId])
  @@index([aestheticClientProfileId])
  @@index([clinicId])
  @@index([professionalId])
  @@index([treatmentCatalogId])
  @@index([startTime])
  @@index([status])
  @@index([createdAt])
}

// Photo Assessment for aesthetic treatments
model PhotoAssessment {
  id                        String    @id @default(uuid())
  aestheticSessionId        String    @map("aesthetic_session_id")
  aestheticSession          AestheticSession @relation(fields: [aestheticSessionId], references: [id], onDelete: Cascade)
  patientId                 String    @map("patient_id")
  patient                   Patient   @relation(fields: [patientId], references: [id])
  aestheticClientProfileId  String    @map("aesthetic_client_profile_id")
  aestheticClientProfile    AestheticClientProfile @relation(fields: [aestheticClientProfileId], references: [id])
  clinicId                  String    @map("clinic_id")
  clinic                    Clinic    @relation(fields: [clinicId], references: [id])

  // Photo information
  photoType                 String    @map("photo_type") // before, after, progress, complication
  photoCategory             String    @map("photo_category") // frontal, profile, close_up, etc.
  photoUrl                  String    @map("photo_url")
  thumbnailUrl              String?   @map("thumbnail_url")
  originalFilename          String?   @map("original_filename")
  fileSize                  Int?      @map("file_size_bytes")
  dimensions                Json?     @map("dimensions") // width, height

  // AI Analysis results
  aiAnalysisResults         Json?     @map("ai_analysis_results") // AI-powered skin analysis
  skinAnalysis              Json?     @map("skin_analysis") // detailed skin condition analysis
  agingAnalysis             Json?     @map("aging_analysis") // aging indicators analysis
  wrinkleAnalysis           Json?     @map("wrinkle_analysis") // wrinkle depth and pattern analysis
  pigmentationAnalysis      Json?     @map("pigmentation_analysis") // pigmentation issues analysis
  textureAnalysis           Json?     @map("texture_analysis") // skin texture analysis

  // Assessment metrics
  overallSkinScore          Int?      @map("overall_skin_score") // 1-100 scale
  agingScore               Int?      @map("aging_score") // 1-100 scale
  hydrationScore           Int?      @map("hydration_score") // 1-100 scale
  elasticityScore          Int?      @map("elasticity_score") // 1-100 scale
  pigmentationScore         Int?      @map("pigmentation_score") // 1-100 scale
  textureScore             Int?      @map("texture_score") // 1-100 scale

  // Treatment progress tracking
  progressPercentage       Int?      @map("progress_percentage") // 0-100% improvement
  treatmentEffectiveness    String?   @map("treatment_effectiveness") // poor, fair, good, excellent
  areasOfImprovement       String[]  @map("areas_of_improvement")
  areasOfConcern           String[]  @map("areas_of_concern")

  // Professional assessment
  professionalNotes         String?   @map("professional_notes")
  assessmentDate           DateTime  @map("assessment_date")
  assessedBy                String    @map("assessed_by") // professional ID
  confidenceLevel           Int?      @map("confidence_level") // 1-10 scale in assessment

  // LGPD compliance
  photoConsentStatus        String    @default("pending") @map("photo_consent_status") // pending, granted, revoked
  photoConsentDate          DateTime? @map("photo_consent_date")
  photoConsentDocument      String?   @map("photo_consent_document")
  usageConsent              String?   @map("usage_consent") // treatment, marketing, education
  retentionPeriod           Int?      @default(365) @map("retention_period_days")

  // Technical metadata
  captureDevice             String?   @map("capture_device")
  cameraSettings            Json?     @map("camera_settings")
  lightingConditions        String?   @map("lighting_conditions")
  photoEditing              Json?     @map("photo_editing") // editing history
  qualityControl            Json?     @map("quality_control") // quality assessment

  // Security and privacy
  isEncrypted              Boolean   @default(false) @map("is_encrypted")
  encryptionMethod         String?   @map("encryption_method")
  accessLevel              String    @default("restricted") @map("access_level")
  watermarkStatus          String    @default("none") @map("watermark_status") // none, added, required

  createdAt                DateTime  @default(now()) @map("created_at")
  updatedAt                DateTime  @updatedAt @map("updated_at")
  createdBy                String    @map("created_by")
  updatedBy                String?   @map("updated_by")

  @@map("photo_assessments")
  @@index([aestheticSessionId])
  @@index([patientId])
  @@index([aestheticClientProfileId])
  @@index([clinicId])
  @@index([photoType])
  @@index([assessmentDate])
  @@index([createdAt])
}

// Treatment Plan for aesthetic clients
model TreatmentPlan {
  id                        String    @id @default(uuid())
  aestheticClientProfileId  String    @map("aesthetic_client_profile_id")
  aestheticClientProfile    AestheticClientProfile @relation(fields: [aestheticClientProfileId], references: [id], onDelete: Cascade)
  patientId                 String    @map("patient_id")
  patient                   Patient   @relation(fields: [patientId], references: [id])
  clinicId                  String    @map("clinic_id")
  clinic                    Clinic    @relation(fields: [clinicId], references: [id])
  professionalId            String    @map("professional_id")
  professional              Professional @relation(fields: [professionalId], references: [id])

  // Plan details
  planName                  String    @map("plan_name")
  planDescription           String    @map("plan_description")
  primaryGoal               String    @map("primary_goal")
  secondaryGoals            String[]  @map("secondary_goals")
  treatmentCategory         String    @map("treatment_category")

  // Timeline and duration
  startDate                 DateTime  @map("start_date")
  endDate                   DateTime?  @map("end_date")
  estimatedDuration          Int       @map("estimated_duration_weeks")
  totalSessions             Int       @map("total_sessions")
  sessionsPerWeek           Int?      @map("sessions_per_week")

  // Financial information
  totalEstimatedCost        Decimal   @map("total_estimated_cost") @db.Decimal(12, 2)
  totalActualCost           Decimal?  @map("total_actual_cost") @db.Decimal(12, 2)
  paymentPlan               Json?     @map("payment_plan") // payment schedule details
  paymentStatus             String    @default("pending") @map("payment_status")

  // Plan status
  status                    String    @default("draft") @map("status") // draft, active, paused, completed, cancelled
  approvalStatus           String    @default("pending") @map("approval_status") // pending, approved, rejected
  approvedBy                String?   @map("approved_by")
  approvedAt                DateTime? @map("approved_at")

  // Progress tracking
  completedSessions         Int       @default(0) @map("completed_sessions")
  progressPercentage        Int       @default(0) @map("progress_percentage")
  overallSatisfaction       Int?      @map("overall_satisfaction") // 1-5 scale
  patientCompliance         String?   @map("patient_compliance") // excellent, good, fair, poor

  // Results tracking
  expectedResults           String[]  @map("expected_results")
  achievedResults           String[]  @map("achieved_results")
  beforeAssessment          Json?     @map("before_assessment")
  afterAssessment           Json?     @map("after_assessment")

  // Notes and documentation
  professionalNotes         String?   @map("professional_notes")
  patientNotes              String?   @map("patient_notes")
  recommendations            String[]  @map("recommendations")
  contraindications         String[]  @map("contraindications")

  createdAt                DateTime  @default(now()) @map("created_at")
  updatedAt                DateTime  @updatedAt @map("updated_at")
  createdBy                String    @map("created_by")
  updatedBy                String?   @map("updated_by")

  // Relations
  treatmentPlanItems        TreatmentPlanItem[]

  @@map("treatment_plans")
  @@index([aestheticClientProfileId])
  @@index([patientId])
  @@index([clinicId])
  @@index([professionalId])
  @@index([status])
  @@index([startDate])
  @@index([createdAt])
}

// Treatment Plan Items
model TreatmentPlanItem {
  id                        String    @id @default(uuid())
  treatmentPlanId           String    @map("treatment_plan_id")
  treatmentPlan             TreatmentPlan @relation(fields: [treatmentPlanId], references: [id], onDelete: Cascade)
  treatmentCatalogId        String    @map("treatment_catalog_id")
  treatmentCatalog          TreatmentCatalog @relation(fields: [treatmentCatalogId], references: [id])

  // Item details
  itemName                  String    @map("item_name")
  itemDescription           String?   @map("item_description")
  treatmentArea             String?   @map("treatment_area")

  // Schedule
  sessionNumber             Int       @map("session_number")
  scheduledDate             DateTime  @map("scheduled_date")
  estimatedDuration         Int       @map("estimated_duration_minutes")

  // Financial information
  estimatedCost             Decimal   @map("estimated_cost") @db.Decimal(10, 2)
  actualCost                Decimal?  @map("actual_cost") @db.Decimal(10, 2)
  paymentStatus             String    @default("pending") @map("payment_status")

  // Status
  status                    String    @default("scheduled") @map("status") // scheduled, in_progress, completed, cancelled, skipped
  completedAt               DateTime? @map("completed_at")
  completedBy                String?   @map("completed_by")

  // Results
  resultsAchieved           String[]  @map("results_achieved")
  patientFeedback           String?   @map("patient_feedback")
  professionalNotes         String?   @map("professional_notes")

  createdAt                DateTime  @default(now()) @map("created_at")
  updatedAt                DateTime  @updatedAt @map("updated_at")

  @@map("treatment_plan_items")
  @@index([treatmentPlanId])
  @@index([treatmentCatalogId])
  @@index([scheduledDate])
  @@index([status])
  @@index([createdAt])
}

// Financial Transactions for aesthetic clinic
model FinancialTransaction {
  id                        String    @id @default(uuid())
  aestheticClientProfileId  String    @map("aesthetic_client_profile_id")
  aestheticClientProfile    AestheticClientProfile @relation(fields: [aestheticClientProfileId], references: [id])
  patientId                 String    @map("patient_id")
  patient                   Patient   @relation(fields: [patientId], references: [id])
  clinicId                  String    @map("clinic_id")
  clinic                    Clinic    @relation(fields: [clinicId], references: [id])

  // Transaction details
  transactionType           String    @map("transaction_type") // payment, refund, credit, debit
  transactionCategory       String    @map("transaction_category") // treatment, product, consultation, package
  transactionSubcategory    String?   @map("transaction_subcategory")

  // Amount information
  amount                    Decimal   @map("amount") @db.Decimal(12, 2)
  currency                  String    @default("BRL")
  taxAmount                 Decimal?  @map("tax_amount") @db.Decimal(10, 2)
  discountAmount            Decimal?  @map("discount_amount") @db.Decimal(10, 2)
  netAmount                 Decimal   @map("net_amount") @db.Decimal(12, 2)

  // Payment method
  paymentMethod             String    @map("payment_method") // cash, credit_card, debit_card, pix, installment
  paymentDetails            Json?     @map("payment_details") // payment method specific details
  installmentInfo           Json?     @map("installment_info") // installment plan details

  // Related items
  relatedSessionId          String?   @map("related_session_id")
  relatedAppointmentId      String?   @map("related_appointment_id")
  relatedTreatmentId         String?   @map("related_treatment_id")
  relatedProductId          String?   @map("related_product_id")

  // Status and processing
  status                    String    @default("pending") @map("status") // pending, processing, completed, failed, refunded
  processor                 String?   @map("processor") // payment processor
  transactionId             String?   @map("transaction_id") // external transaction ID
  authorizationCode         String?   @map("authorization_code")
  receiptNumber             String?   @map("receipt_number")

  // Dates
  transactionDate           DateTime  @map("transaction_date")
  processedAt               DateTime? @map("processed_at")
  refundedAt                DateTime?   @map("refunded_at")

  // Notes and documentation
  description               String?   @map("description")
  notes                     String?   @map("notes")
  invoiceNumber             String?   @map("invoice_number")
  fiscalDocument            Json?     @map("fiscal_document") // Brazilian fiscal document

  // Compliance
  lgpdCompliant             Boolean   @default(true) @map("lgpd_compliant")
  dataRetentionPolicy        String?   @map("data_retention_policy")

  createdAt                DateTime  @default(now()) @map("created_at")
  updatedAt                DateTime  @updatedAt @map("updated_at")
  createdBy                String    @map("created_by")
  updatedBy                String?   @map("updated_by")

  @@map("financial_transactions")
  @@index([aestheticClientProfileId])
  @@index([patientId])
  @@index([clinicId])
  @@index([transactionType])
  @@index([transactionDate])
  @@index([status])
  @@index([createdAt])
}

// Client Retention Records
model ClientRetentionRecord {
  id                        String    @id @default(uuid())
  aestheticClientProfileId  String    @map("aesthetic_client_profile_id")
  aestheticClientProfile    AestheticClientProfile @relation(fields: [aestheticClientProfileId], references: [id], onDelete: Cascade)
  patientId                 String    @map("patient_id")
  patient                   Patient   @relation(fields: [patientId], references: [id])
  clinicId                  String    @map("clinic_id")
  clinic                    Clinic    @relation(fields: [clinicId], references: [id])

  // Retention metrics
  retentionRiskScore        Int       @map("retention_risk_score") // 0-100 scale
  retentionRiskLevel        String    @map("retention_risk_level") // low, medium, high
  churnProbability          Decimal?  @map("churn_probability") @db.Decimal(5, 4) // 0.0-1.0

  // Behavioral indicators
  visitFrequency            Int?      @map("visit_frequency") // visits per month
  averageSpendPerVisit      Decimal?  @map("average_spend_per_visit") @db.Decimal(10, 2)
  lastVisitDate             DateTime?  @map("last_visit_date")
  daysSinceLastVisit       Int?      @map("days_since_last_visit")
  nextAppointmentDate       DateTime?  @map("next_appointment_date")
  appointmentHistory        Json?     @map("appointment_history") // recent appointment patterns

  // Engagement metrics
  engagementScore           Int?      @map("engagement_score") // 1-100 scale
  communicationResponseRate  Decimal?  @map("communication_response_rate") @db.Decimal(5, 2) // percentage
  marketingInteractionCount Int?      @map("marketing_interaction_count")
  lastMarketingInteraction  DateTime? @map("last_marketing_interaction")

  // Satisfaction metrics
  satisfactionScore         Int?      @map("satisfaction_score") // 1-5 scale
  netPromoterScore          Int?      @map("net_promoter_score") // -100 to +100
  likelihoodToRefer         Int?      @map("likelihood_to_refer") // 1-10 scale
  lastFeedbackDate          DateTime?  @map("last_feedback_date")
  feedbackSentiment         String?   @map("feedback_sentiment") // positive, neutral, negative

  // Financial metrics
  totalLifetimeValue        Decimal?  @map("total_lifetime_value") @db.Decimal(12, 2)
  averageMonthlySpend       Decimal?  @map("average_monthly_spend") @db.Decimal(10, 2)
  paymentHistory            Json?     @map("payment_history") // payment patterns and reliability
  outstandingBalance        Decimal?  @map("outstanding_balance") @db.Decimal(10, 2)

  // Treatment effectiveness
  treatmentEffectiveness    String?   @map("treatment_effectiveness") // poor, fair, good, excellent
  resultsAchievement        Int?      @map("results_achievement") // 1-100 scale
  treatmentCompliance       String?   @map("treatment_compliance") // poor, fair, good, excellent

  // Predictive factors
  riskFactors               Json?     @map("risk_factors") // individual risk factors with weights
  predictiveModelVersion    String?   @map("predictive_model_version")
  predictionConfidence      Decimal?  @map("prediction_confidence") @db.Decimal(5, 4) // 0.0-1.0
  lastPredictionDate        DateTime? @map("last_prediction_date")

  // Intervention history
  retentionInterventions    Json?     @map("retention_interventions") // interventions attempted
  interventionEffectiveness Json?     @map("intervention_effectiveness") // effectiveness of interventions
  lastInterventionDate      DateTime?  @map("last_intervention_date")

  // Recommendations
  retentionRecommendations  String[]  @map("retention_recommendations")
  actionItems               String[]  @map("action_items")
  followUpActions          String[]  @map("follow_up_actions")

  // Status and tracking
  status                    String    @default("active") @map("status") // active, lost, reactivated, dormant
  reassessmentDate          DateTime?   @map("reassessment_date")

  createdAt                DateTime  @default(now()) @map("created_at")
  updatedAt                DateTime  @updatedAt @map("updated_at")
  createdBy                String    @map("created_by")
  updatedBy                String?   @map("updated_by")

  @@map("client_retention_records")
  @@index([aestheticClientProfileId])
  @@index([patientId])
  @@index([clinicId])
  @@index([retentionRiskScore])
  @@index([retentionRiskLevel])
  @@index([lastVisitDate])
  @@index([createdAt])
}