#!/usr/bin/env node

/**
 * Script de Teste Completo do Sistema de Assinaturas Stripe
 *
 * Este script testa todos os componentes do sistema de assinaturas:
 * - Conex√£o com APIs
 * - Endpoints Stripe
 * - Banco de dados
 * - Configura√ß√£o de environment
 * - Fluxo completo de assinatura
 */

const https = require('node:https');
const http = require('node:http');
const { execSync } = require('node:child_process');

// Configura√ß√µes
const BASE_URL = process.env.NEXTAUTH_URL || 'http://localhost:3000';
const STRIPE_WEBHOOK_SECRET = process.env.STRIPE_WEBHOOK_SECRET;
const STRIPE_PUBLISHABLE_KEY = process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY;
const STRIPE_SECRET_KEY = process.env.STRIPE_SECRET_KEY;

console.log('üß™ TESTE COMPLETO DO SISTEMA DE ASSINATURAS STRIPE');
console.log('='.repeat(60));
console.log(`üåê Base URL: ${BASE_URL}`);
console.log(`üìÖ Data: ${new Date().toLocaleString('pt-BR')}`);
console.log('='.repeat(60));

let totalTests = 0;
let passedTests = 0;
let failedTests = 0;
const failedTestsList = [];

// Fun√ß√£o para fazer requisi√ß√µes HTTP
function makeRequest(url, options = {}) {
  return new Promise((resolve, reject) => {
    const requestModule = url.startsWith('https://') ? https : http;

    const req = requestModule.request(
      url,
      {
        method: options.method || 'GET',
        headers: {
          'Content-Type': 'application/json',
          'User-Agent': 'NeonPro-Test-Agent/1.0',
          ...options.headers,
        },
      },
      (res) => {
        let data = '';
        res.on('data', (chunk) => (data += chunk));
        res.on('end', () => {
          try {
            const jsonData = data ? JSON.parse(data) : {};
            resolve({
              status: res.statusCode,
              data: jsonData,
              headers: res.headers,
            });
          } catch (_e) {
            resolve({ status: res.statusCode, data, headers: res.headers });
          }
        });
      }
    );

    req.on('error', reject);

    if (options.body) {
      req.write(JSON.stringify(options.body));
    }

    req.end();
  });
}

// Fun√ß√£o para executar testes
async function runTest(name, testFn) {
  totalTests++;
  try {
    console.log(`\nüîÑ Testando: ${name}`);
    await testFn();
    console.log(`‚úÖ PASSOU: ${name}`);
    passedTests++;
  } catch (error) {
    console.log(`‚ùå FALHOU: ${name}`);
    console.log(`   Erro: ${error.message}`);
    failedTests++;
    failedTestsList.push({ name, error: error.message });
  }
}

// 1. Teste de Vari√°veis de Ambiente
async function testEnvironmentVariables() {
  const requiredVars = {
    NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: STRIPE_PUBLISHABLE_KEY,
    STRIPE_SECRET_KEY,
    STRIPE_WEBHOOK_SECRET,
  };

  for (const [varName, value] of Object.entries(requiredVars)) {
    if (!value) {
      throw new Error(`Vari√°vel ${varName} n√£o configurada`);
    }
    if (
      varName.includes('STRIPE') &&
      !value.startsWith('pk_') &&
      !value.startsWith('sk_') &&
      !value.startsWith('whsec_')
    ) {
      throw new Error(`Vari√°vel ${varName} tem formato inv√°lido`);
    }
  }

  console.log('   ‚úì Todas as vari√°veis de ambiente Stripe est√£o configuradas');
}

// 2. Teste de Conectividade da API
async function testAPIConnectivity() {
  const response = await makeRequest(`${BASE_URL}/api/health`);

  if (response.status === 404) {
    // Health endpoint n√£o existe, vamos testar uma rota que sabemos que existe
    const pingResponse = await makeRequest(
      `${BASE_URL}/api/subscription/current`
    );
    if (pingResponse.status >= 200 && pingResponse.status < 500) {
      console.log(
        '   ‚úì API est√° respondendo (health endpoint n√£o implementado)'
      );
      return;
    }
  }

  if (response.status !== 200) {
    throw new Error(`API n√£o est√° respondendo. Status: ${response.status}`);
  }

  console.log('   ‚úì API est√° respondendo corretamente');
}

// 3. Teste de Endpoints Stripe
async function testStripeEndpoints() {
  const endpoints = [
    '/api/stripe/create-checkout-session',
    '/api/stripe/create-billing-portal-session',
    '/api/webhooks/stripe',
    '/api/subscription/current',
  ];

  for (const endpoint of endpoints) {
    const response = await makeRequest(`${BASE_URL}${endpoint}`, {
      method: endpoint.includes('webhook') ? 'POST' : 'GET',
    });

    // Para endpoints que requerem autentica√ß√£o, 401 √© esperado
    if (response.status === 401 || response.status === 405) {
      console.log(
        `   ‚úì Endpoint ${endpoint} est√° configurado (requer auth/m√©todo correto)`
      );
      continue;
    }

    if (response.status >= 500) {
      throw new Error(
        `Endpoint ${endpoint} retornou erro de servidor: ${response.status}`
      );
    }

    console.log(`   ‚úì Endpoint ${endpoint} est√° funcionando`);
  }
}

// 4. Teste de Configura√ß√£o Stripe
async function testStripeConfiguration() {
  try {
    // Simular cria√ß√£o de customer de teste
    const stripe = require('stripe')(STRIPE_SECRET_KEY);

    const testCustomer = await stripe.customers.create({
      email: 'teste@neonpro.com',
      name: 'Teste NeonPro',
      metadata: { test: 'true' },
    });

    if (!testCustomer.id) {
      throw new Error('Falha ao criar customer de teste');
    }

    console.log('   ‚úì Conex√£o com Stripe API funcionando');

    // Limpar customer de teste
    await stripe.customers.del(testCustomer.id);
    console.log('   ‚úì Customer de teste removido');
  } catch (error) {
    throw new Error(`Erro na configura√ß√£o Stripe: ${error.message}`);
  }
}

// 5. Teste de Planos de Assinatura
async function testSubscriptionPlans() {
  const stripe = require('stripe')(STRIPE_SECRET_KEY);

  const expectedPrices = [
    'price_starter_monthly',
    'price_professional_monthly',
    'price_enterprise_monthly',
  ];

  let foundPrices = 0;

  try {
    const prices = await stripe.prices.list({ limit: 100 });

    for (const priceId of expectedPrices) {
      const price = prices.data.find((p) => p.id === priceId);
      if (price) {
        foundPrices++;
        console.log(
          `   ‚úì Plano ${priceId} encontrado: ${price.unit_amount / 100} ${price.currency.toUpperCase()}`
        );
      } else {
        console.log(`   ‚ö†Ô∏è  Plano ${priceId} n√£o encontrado no Stripe`);
      }
    }

    if (foundPrices === 0) {
      throw new Error('Nenhum plano de assinatura encontrado no Stripe');
    }

    console.log(
      `   ‚úì ${foundPrices}/${expectedPrices.length} planos encontrados`
    );
  } catch (error) {
    throw new Error(`Erro ao verificar planos: ${error.message}`);
  }
}

// 6. Teste de Schema do Banco de Dados (simulado)
async function testDatabaseSchema() {
  // Teste b√°sico de endpoints que dependem do banco
  const response = await makeRequest(`${BASE_URL}/api/subscription/current`);

  if (response.status === 500) {
    throw new Error(
      'Poss√≠vel erro de schema do banco - endpoint retornando 500'
    );
  }

  console.log('   ‚úì Endpoints que dependem do banco est√£o respondendo');
  console.log('   ‚ÑπÔ∏è  Para teste completo do banco, execute: npm run test:db');
}

// 7. Teste de Webhook Stripe (simulado)
async function testStripeWebhook() {
  if (!STRIPE_WEBHOOK_SECRET) {
    throw new Error('STRIPE_WEBHOOK_SECRET n√£o configurado');
  }

  // Teste b√°sico do endpoint webhook
  const response = await makeRequest(`${BASE_URL}/api/webhooks/stripe`, {
    method: 'POST',
    headers: {
      'stripe-signature': 'test-signature',
    },
    body: { type: 'test.event' },
  });

  // Esperamos 400 porque n√£o temos assinatura v√°lida, mas o endpoint deve estar ativo
  if (response.status >= 500) {
    throw new Error(
      `Webhook endpoint retornando erro de servidor: ${response.status}`
    );
  }

  console.log('   ‚úì Webhook endpoint est√° configurado');
  console.log(
    '   ‚ÑπÔ∏è  Para testar webhooks reais, configure ngrok e teste no Stripe Dashboard'
  );
}

// 8. Teste de Interface de Usu√°rio
async function testUserInterface() {
  const pages = [
    '/pricing',
    '/dashboard/subscription/success',
    '/dashboard/subscription/manage',
    '/dashboard/subscription/expired',
  ];

  for (const page of pages) {
    try {
      const response = await makeRequest(`${BASE_URL}${page}`);

      if (
        response.status === 200 ||
        response.status === 401 ||
        response.status === 302
      ) {
        console.log(`   ‚úì P√°gina ${page} est√° acess√≠vel`);
      } else if (response.status >= 500) {
        throw new Error(`P√°gina ${page} retornando erro: ${response.status}`);
      }
    } catch (error) {
      console.log(
        `   ‚ö†Ô∏è  P√°gina ${page} pode estar inacess√≠vel: ${error.message}`
      );
    }
  }
}

// 9. Teste de Performance
async function testPerformance() {
  const start = Date.now();

  const _response = await makeRequest(`${BASE_URL}/api/subscription/current`);

  const duration = Date.now() - start;

  if (duration > 5000) {
    throw new Error(`Endpoint muito lento: ${duration}ms`);
  }

  console.log(`   ‚úì Tempo de resposta aceit√°vel: ${duration}ms`);
}

// 10. Teste de Seguran√ßa B√°sica
async function testBasicSecurity() {
  // Teste se endpoints protegidos est√£o realmente protegidos
  const protectedEndpoints = [
    '/api/stripe/create-checkout-session',
    '/api/stripe/create-billing-portal-session',
    '/api/subscription/current',
  ];

  for (const endpoint of protectedEndpoints) {
    const response = await makeRequest(`${BASE_URL}${endpoint}`);

    if (response.status === 200) {
      throw new Error(`Endpoint ${endpoint} pode estar desprotegido`);
    }

    if (response.status === 401 || response.status === 403) {
      console.log(`   ‚úì Endpoint ${endpoint} est√° protegido`);
    }
  }
}

// Fun√ß√£o principal
async function main() {
  console.log('üöÄ Iniciando testes...\n');

  // Lista de testes para executar
  const tests = [
    ['Vari√°veis de Ambiente', testEnvironmentVariables],
    ['Conectividade da API', testAPIConnectivity],
    ['Endpoints Stripe', testStripeEndpoints],
    ['Configura√ß√£o Stripe', testStripeConfiguration],
    ['Planos de Assinatura', testSubscriptionPlans],
    ['Schema do Banco de Dados', testDatabaseSchema],
    ['Webhook Stripe', testStripeWebhook],
    ['Interface de Usu√°rio', testUserInterface],
    ['Performance', testPerformance],
    ['Seguran√ßa B√°sica', testBasicSecurity],
  ];

  // Executar todos os testes
  for (const [name, testFn] of tests) {
    await runTest(name, testFn);
  }

  // Relat√≥rio final
  console.log(`\n${'='.repeat(60)}`);
  console.log('üìä RELAT√ìRIO FINAL');
  console.log('='.repeat(60));
  console.log(`‚úÖ Testes Passaram: ${passedTests}/${totalTests}`);
  console.log(`‚ùå Testes Falharam: ${failedTests}/${totalTests}`);

  if (failedTests > 0) {
    console.log('\n‚ùå Testes que Falharam:');
    failedTestsList.forEach((test, i) => {
      console.log(`${i + 1}. ${test.name}: ${test.error}`);
    });
  }

  const successRate = ((passedTests / totalTests) * 100).toFixed(1);
  console.log(`\nüìà Taxa de Sucesso: ${successRate}%`);

  if (successRate >= 80) {
    console.log('üéâ Sistema de assinaturas est√° em boa condi√ß√£o!');
  } else if (successRate >= 60) {
    console.log('‚ö†Ô∏è  Sistema precisa de algumas corre√ß√µes');
  } else {
    console.log('üö® Sistema precisa de corre√ß√µes cr√≠ticas');
  }

  console.log(`\n${'='.repeat(60)}`);
  console.log('üìù Pr√≥ximos Passos Recomendados:');

  if (failedTestsList.some((t) => t.name.includes('Stripe'))) {
    console.log('1. Configurar produtos e pre√ßos no Stripe Dashboard');
    console.log('2. Verificar vari√°veis de ambiente Stripe');
  }

  if (failedTestsList.some((t) => t.name.includes('Banco'))) {
    console.log('3. Executar migration do banco: supabase db push');
  }

  if (failedTestsList.some((t) => t.name.includes('API'))) {
    console.log('4. Verificar se o servidor est√° rodando: pnpm run dev');
  }

  console.log('5. Executar testes espec√≠ficos com: pnpm run test:[categoria]');
  console.log('6. Configurar webhook com ngrok para testes locais');

  process.exit(failedTests > 0 ? 1 : 0);
}

// Executar se for chamado diretamente
if (require.main === module) {
  main().catch((error) => {
    console.error('üí• Erro cr√≠tico durante os testes:', error);
    process.exit(1);
  });
}

module.exports = {
  runTest,
  makeRequest,
  main,
};
