#!/usr/bin/env sh

echo "ğŸš€ Running pre-push quality validation..."

# 1. Full TypeScript compilation check
echo "ğŸ” Running full TypeScript compilation check..."
if ! bunx tsc --noEmit --skipLibCheck; then
  echo "âŒ TypeScript compilation failed"
  echo "ğŸ’¡ Fix all TypeScript errors before pushing"
  exit 1
fi
echo "âœ… TypeScript compilation passed"

# 2. Comprehensive quality assessment
echo "ğŸ” Running comprehensive quality assessment..."

# Count total violations
TOTAL_VIOLATIONS=$(bunx oxlint --quiet 2>/dev/null | wc -l || echo "0")
ANY_VIOLATIONS=$(bunx oxlint --quiet 2>/dev/null | grep -c "typescript-eslint(no-explicit-any)" || echo "0")
SECURITY_VIOLATIONS=$(bunx oxlint --quiet 2>/dev/null | grep -c "security" || echo "0")

echo "ğŸ“Š Quality Metrics:"
echo "   - Total violations: $TOTAL_VIOLATIONS"
echo "   - Type safety issues: $ANY_VIOLATIONS"
echo "   - Security issues: $SECURITY_VIOLATIONS"

# Critical checks
if [ $SECURITY_VIOLATIONS -gt 0 ]; then
  echo "âŒ CRITICAL: Security violations detected ($SECURITY_VIOLATIONS)"
  echo "ğŸ’¡ Resolve all security issues before pushing"
  exit 1
fi

# Quality thresholds
if [ $TOTAL_VIOLATIONS -gt 500 ]; then
  echo "âŒ QUALITY GATE FAILED: Too many violations ($TOTAL_VIOLATIONS > 500)"
  echo "ğŸ’¡ Reduce violations before pushing to maintain code quality"
  exit 1
fi

if [ $ANY_VIOLATIONS -gt 100 ]; then
  echo "âš ï¸ WARNING: High number of 'any' types ($ANY_VIOLATIONS)"
  echo "ğŸ’¡ Consider improving type safety"
fi

# 3. Test execution (if tests exist)
if [ -f "package.json" ] && grep -q '"test"' package.json; then
  echo "ğŸ§ª Running tests..."
  if ! npm test; then
    echo "âŒ Tests failed"
    echo "ğŸ’¡ Fix failing tests before pushing"
    exit 1
  fi
  echo "âœ… Tests passed"
fi

echo ""
echo "âœ… All pre-push quality checks passed!"
echo "ğŸš€ Ready to push"
