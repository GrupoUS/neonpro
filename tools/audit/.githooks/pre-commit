#!/bin/sh
# NeonPro Audit System - Pre-commit Hook
# Constitutional TDD compliance validation before commits

echo "🏛️ Running Constitutional TDD Audit Pre-commit Check..."

# Check if audit tool is available
if ! command -v npx >/dev/null 2>&1; then
    echo "❌ Error: npx not found. Please install Node.js"
    exit 1
fi

# Navigate to audit tool directory
cd "$(git rev-parse --show-toplevel)/tools/audit" || exit 1

# Run quick validation on staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo "✅ No TypeScript/JavaScript files to validate"
    exit 0
fi

echo "📁 Validating ${#STAGED_FILES} staged files..."

# Run quick audit on project root
if ! timeout 60 npx tsx src/cli/index.ts quick --target "$(git rev-parse --show-toplevel)" --verbose; then
    echo ""
    echo "❌ Constitutional TDD Audit Failed!"
    echo ""
    echo "🔍 Issues found in your changes. Please fix them before committing:"
    echo "   • Run: cd tools/audit && npx tsx src/cli/index.ts quick --verbose"
    echo "   • Check constitutional compliance requirements"
    echo "   • Ensure code quality meets ≥9.5/10 standard"
    echo ""
    echo "💡 Tips:"
    echo "   • Use 'git commit --no-verify' to skip (NOT recommended)"
    echo "   • Check logs in tools/audit/audit-reports/"
    echo ""
    exit 1
fi

echo ""
echo "✅ Constitutional TDD Audit Passed!"
echo "🏛️ Your changes meet constitutional compliance standards"
echo ""

exit 0